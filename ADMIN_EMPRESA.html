<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARCIA TRANSPORTES - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="./libs/geoapify-autocomplete.css" />
    <script src="./libs/geoapify-autocomplete.min.js"></script>
    <style>
        body, html { background-color: #000; }
        .main-gradient { background: linear-gradient(135deg, #000000, #000000); }
        .button-gradient { background: linear-gradient(to right, #000000, #000000); border: 2px solid white; position: relative; overflow: hidden; color: white !important; } /* Garante texto branco */
        .button-gradient::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0.3), rgba(255,255,255,0)); transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        .button-gradient:hover::before { transform: translateX(0); }
        .card-gradient { background: linear-gradient(135deg, #000000, #000000); border: 1px solid #4b5563; } /* Adiciona borda sutil */
        .screen { display: none; background-color: #000; }
        .screen.active { display: block; }
        .text-black, .text-gray-800, .text-gray-400, .text-gray-300, .text-gray-600, .text-gray-700, .text-gray-500, .text-green-300, .text-yellow-300 { color: #ffffff !important; }
        .text-cyan-400 { color: #00ffff !important; }
        h1, h2, h3, p, button, label, input::placeholder, textarea::placeholder, select, option { color: #ffffff !important; }
        input, select, textarea { background-color: #374151 !important; border-color: #4b5563 !important; color: white !important; /* Garante texto branco */}
        input:focus, select:focus, textarea:focus { border-color: #00ffff !important; ring: none !important; outline: none !important; box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.5) !important; } /* Foco ciano */
        #company-password-input { font-size: 14px; text-align: center; }
        #company-password-input::placeholder { text-align: center; }
        #app-container { position: relative; }
        #admin-access-icon:hover svg { stroke: #fff; }

        /* ESTILO PARA O AUTOCOMPLETE DO GEOAPIFY (usando arquivo local) */
        .autocomplete-container { position: relative; }
        /* A aparencia virá do arquivo CSS local, mas podemos adicionar overrides aqui se necessário */
        .geoapify-autocomplete-input {
             /* Seus estilos existentes para inputs serão aplicados pela biblioteca */
             width: 100% !important; /* Garante largura total */
             box-sizing: border-box !important;
        }
        .geoapify-autocomplete-items {
            background-color: #374151 !important; /* Fundo escuro */
            border: 1px solid #4b5563 !important;
            color: white !important;
            z-index: 1050 !important;
            max-height: 200px; overflow-y: auto;
        }
        .geoapify-autocomplete-items div:hover { background-color: #4b5563 !important; } /* Hover */
        .geoapify-autocomplete-item.active { background-color: #00ffff !important; color: black !important; } /* Selecionado */
        /* FIM DO ESTILO DO AUTOCOMPLETE */

        #schedule-modal { display: none; }
        #schedule-modal.flex { display: flex; }

        /* --- CSS PARA ABAS --- */
        .tab-button { background-color: #374151; border: 1px solid #4b5563; padding: 10px 15px; cursor: pointer; transition: all 0.2s ease-in-out; border-radius: 8px; font-weight: 600; color: white !important; }
        .tab-button.active { background-color: #00ffff; color: #000 !important; border-color: #00ffff; }
        .admin-sub-screen { display: none; }
        .admin-sub-screen.active { display: block; }

    </style>
</head>
<body class="main-gradient text-white min-h-screen flex items-start justify-center p-4 pt-8">

    <div id="app-container" class="w-full max-w-md mx-auto">

        <div id="company-login-screen" class="screen active">
            <div id="admin-access-icon" title="Acesso Super Admin" onclick="showSuperAdminLogin()" style="position: absolute; top: 1rem; right: 1rem; cursor: pointer; padding: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
            </div>
            <h2 class="text-3xl font-bold mb-6 text-center">Login da Empresa</h2>
            <div class="mb-4"><label for="company-login-select" class="block mb-2 text-sm font-medium">Empresa</label><select id="company-login-select" class="w-full p-3 rounded-lg"></select></div>
            <div class="mb-4"><label for="admin-username-input" class="block mb-2 text-sm font-medium">Usuário Admin</label><input type="text" id="admin-username-input" class="w-full p-3 rounded-lg" placeholder="Digite seu usuário"></div>
            <div class="mb-4"><label for="admin-password-input" class="block mb-2 text-sm font-medium">Senha</label><input type="password" id="admin-password-input" class="w-full p-3 rounded-lg" placeholder="Digite sua senha"></div>
            <button onclick="verifyCompanyAdminPassword()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">ENTRAR</button>
            <p id="company-login-error" class="text-red-500 text-center mt-4 hidden">Usuário ou senha incorretos!</p>
            <p class="text-xs text-center text-gray-400 mt-4">
                Esqueceu a senha? Use o acesso Super Admin (ícone de escudo <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 align-text-bottom" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> no canto superior direito) para gerenciar as empresas.
            </p>
        </div>
        <div id="super-admin-login-screen" class="screen">
            <button onclick="showScreen('company-login-screen')" class="mb-4 text-cyan-400 hover:text-cyan-200">← Voltar</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Acesso Super Admin</h2>
            <div class="mb-4"><label for="super-admin-password-input" class="block mb-2 text-sm font-medium">Senha Mestra</label><input type="password" id="super-admin-password-input" class="w-full p-3 rounded-lg text-center" placeholder="Digite a senha mestra"></div>
            <button onclick="verifySuperAdminPassword()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">ENTRAR</button>
            <p id="super-admin-login-error" class="text-red-500 text-center mt-4 hidden">Senha mestra incorreta!</p>
        </div>

        <div id="admin-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <p id="admin-welcome-message" class="text-lg text-gray-300"></p>
                <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 p-2 rounded-lg">Sair</button>
            </div>
            <div class="flex flex-wrap justify-center gap-2 mb-6">
                <button id="tab-request-ride" class="tab-button active" onclick="showAdminSubScreen('request-ride-screen')">Solicitar Corrida</button>
                <button id="tab-approve-ride" class="tab-button" onclick="showAdminSubScreen('approval-ride-screen')">Aprovar Solicitações</button>
                <button id="tab-history" class="tab-button" onclick="showAdminSubScreen('history-screen')">Histórico</button>
                <button id="tab-users" class="tab-button" onclick="showAdminSubScreen('user-management-screen')">Gerenciar Usuários</button>
            </div>
            <div id="request-ride-screen" class="admin-sub-screen active">
                <h2 class="text-2xl font-bold text-center mb-4">Solicitar Corrida</h2>
                <div id="admin-request-form" class="card-gradient p-6 rounded-lg">
                    <div class="mb-4">
                        <label for="passenger-quantity-select" class="block mb-2 text-sm font-medium">SELECIONE A QUANTIDADE DE PASSAGEIROS</label>
                        <select id="passenger-quantity-select" class="w-full p-3 rounded-lg">
                            <option value="">-- Quantidade --</option>
                            <option value="1">1 Passageiro</option>
                            <option value="2">2 Passageiros</option>
                            <option value="3">3 Passageiros</option>
                            <option value="4">4 Passageiros</option>
                        </select>
                    </div>
                    <div id="collaborators-container" class="space-y-4"></div>
                    <div id="admin-ride-details" class="hidden">
                        <hr class="border-gray-600 my-6">
                        <h3 class="text-lg font-semibold mb-4 text-center">Detalhes da Viagem</h3>
                        <div class="mb-4">
                            <label for="admin-observation" class="block mb-2 text-sm font-medium">Observação</label>
                            <textarea id="admin-observation" class="w-full p-3 rounded-lg" placeholder="Ex: Ponto de referência..." rows="2"></textarea>
                        </div>
                        <div class="mt-6 space-y-3">
                            <button id="admin-request-immediate-btn" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">SOLICITAR AGORA</button>
                            <button id="admin-request-scheduled-btn" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg">AGENDAR</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="approval-ride-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Aprovar Solicitações Pendentes</h2>
                <div id="pending-rides-container" class="space-y-4"></div>
            </div>
            <div id="history-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Histórico de Corridas</h2>
                <div id="history-rides-container" class="space-y-4"></div>
            </div>
            <div id="user-management-screen" class="admin-sub-screen">
                <h2 class="text-2xl font-bold text-center mb-4">Gerenciar Usuários</h2>
                <div class="card-gradient p-4 rounded-lg mb-6">
                    <h3 id="user-form-title" class="text-lg font-semibold mb-2">Adicionar Usuário</h3>
                    <input type="hidden" id="editing-user-id">
                    <div class="space-y-2">
                        <input type="text" id="new-user-matricula" placeholder="Matrícula" class="w-full p-2 rounded-lg">
                        <input type="text" id="new-user-name" placeholder="Nome Completo" class="w-full p-2 rounded-lg">
                        <div class="autocomplete-container">
                            <input type="text" id="new-user-address" placeholder="Endereço" class="w-full p-2 rounded-lg">
                        </div>
                        <input type="tel" id="new-user-phone" placeholder="Telefone" class="w-full p-2 rounded-lg">
                        <input type="text" id="new-user-password" placeholder="Senha" class="w-full p-2 rounded-lg">
                    </div>
                    <button onclick="addOrUpdateUser()" class="w-full py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700 mt-3">Salvar</button>
                    <button id="cancel-user-edit-btn" onclick="cancelUserEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
                </div>
                <div id="user-list-container" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div id="company-management-screen" class="screen">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Gerenciar Empresas</h2>
                <button onclick="logout()" class="text-sm bg-red-600 hover:bg-red-700 p-2 rounded-lg">Sair</button>
            </div>
            <div class="card-gradient p-4 rounded-lg mb-6">
                <h3 id="company-form-title" class="text-lg font-semibold mb-2">Adicionar Empresa</h3>
                <input type="hidden" id="editing-company-id">
                <div class="flex gap-2 mb-2">
                    <input type="text" id="new-company-name" placeholder="Nome da Empresa" class="w-full p-2 rounded-lg">
                </div>
                <button onclick="addOrUpdateCompany()" class="w-full py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700">Salvar</button>
                <button id="cancel-edit-btn" onclick="cancelEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
            </div>
            <div id="company-list-container" class="space-y-3"></div>
        </div>
        <div id="admin-management-screen" class="screen"></div>

    </div>

    <div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4">Agendar Corrida</h3>
            <div class="mb-4 text-left">
                <label for="schedule-date" class="block mb-2 text-sm font-medium">Data</label>
                <input type="date" id="schedule-date" class="w-full p-3 rounded-lg" style="color-scheme: dark;">
            </div>
            <div class="mb-6 text-left">
                <label for="schedule-time" class="block mb-2 text-sm font-medium">Hora</label>
                <input type="time" id="schedule-time" class="w-full p-3 rounded-lg" style="color-scheme: dark;">
            </div>
            <div class="flex justify-center gap-4">
                <button onclick="closeScheduleModal()" class="py-2 px-6 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600">Cancelar</button>
                <button onclick="confirmAdminSchedule()" class="py-2 px-8 font-semibold rounded-lg button-gradient">AGENDAR</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // CONSTANTES GLOBAIS
        // ========================================================================
        const SUPABASE_URL = 'https://jowsbmuqbzxukbbxbeqv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvd3NibXVxYnp4dWtiYnhiZXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzA5NjQsImV4cCI6MjA3MTA0Njk2NH0.UMW2aQmuq0RiEHgody5StKEQzDjrKZnfUprDgDaMd1w';
        const GEOAPIFY_API_KEY = '3bd73ecada1d478a8c9473ad4115be38'; // Sua chave Geoapify
       
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
       
        let state = { loggedInCompany: null, loggedInAdmin: null, allUsers: [] };
        let adminSelectedRequestType = '';
        let adminScheduledDateTime = null;
        let companyUsersCache = [];
        let currentManagingCompany = { id: null, name: null };


        // ========================================================================
        // FUNÇÃO ATUALIZADA - initAutocomplete (Usa Geoapify via arquivo local)
        // ========================================================================
        function initAutocomplete(inputElement) {
            if (!inputElement) return;
            if (typeof Autocomplete === 'undefined') {
                console.error("ERRO: Biblioteca Autocomplete (Geoapify) não foi definida. Verifique o carregamento do script local.");
                return;
            }

            if (inputElement.geoapify_autocomplete_instance) {
                try { inputElement.geoapify_autocomplete_instance.destroy(); } catch(e) {}
                inputElement.geoapify_autocomplete_instance = null;
            }

            try {
                const autocomplete = new Autocomplete(inputElement, {
                    apiKey: GEOAPIFY_API_KEY,
                    filter: { countrycode: ['br'] },
                    lang: 'pt',
                    placeholder: inputElement.placeholder,
                    allowNonVerifiedHouseNumber: true,
                    allowNonVerifiedStreet: true
                });
                inputElement.geoapify_autocomplete_instance = autocomplete;
                // console.log("Autocomplete inicializado para:", inputElement.id); // Log opcional
            } catch (error) {
                console.error("Erro ao inicializar Geoapify Autocomplete:", error, "no elemento:", inputElement);
            }
        }
        
        // ========================================================================
        // FUNÇÃO ATUALIZADA - parseDestinations
        // ========================================================================
        function parseDestinations(destinationString) {
             if (!destinationString || typeof destinationString !== 'string') return [];
             const str = destinationString.trim();
             if (str.startsWith('[') && str.endsWith(']')) {
                 try {
                     const parsed = JSON.parse(str);
                     if (Array.isArray(parsed)) {
                         if (parsed.length > 0 && typeof parsed[0] === 'object' && parsed[0] !== null && 'address' in parsed[0]) {
                            return parsed.filter(d => d.address); // Retorna objetos válidos
                         }
                          return parsed.map((addr, index) => ({
                              name: index === parsed.length - 1 ? 'Destino Final' : `Parada ${index + 1}`,
                              address: String(addr || '').trim()
                          })).filter(d => d.address);
                     }
                 } catch (e) { console.warn('parseDestinations: JSON inválido.', str, e); }
             }
              const cleanedAddr = str.replace(/^\["|"\]$/g, '').trim();
              return cleanedAddr ? [{ name: 'Destino', address: cleanedAddr }] : [];
        }

        // --- Restante do JavaScript (sem alterações significativas, exceto chamadas a initAutocomplete) ---
       
        function resetAdminForm() {
            document.getElementById('passenger-quantity-select').value = '';
            document.getElementById('collaborators-container').innerHTML = '';
            document.getElementById('admin-ride-details').classList.add('hidden');
            document.getElementById('admin-observation').value = '';
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
        }

        function logout() {
            state.loggedInCompany = null;
            state.loggedInAdmin = null;
            document.getElementById('admin-username-input').value = '';
            document.getElementById('admin-password-input').value = '';
            document.getElementById('super-admin-password-input').value = '';
            resetAdminForm();
            showScreen('company-login-screen');
        }

        function showSuperAdminLogin() {
            showScreen('super-admin-login-screen');
        }

        async function verifySuperAdminPassword() {
            const passwordInput = document.getElementById('super-admin-password-input');
            const password = passwordInput.value;
            const errorEl = document.getElementById('super-admin-login-error');
            errorEl.classList.add('hidden');
            if (password === '789512') {
                state.loggedInCompany = { name: "Super Admin" };
                state.loggedInAdmin = { username: "Super Admin" };
                await loadCompanyManagement();
                showScreen('company-management-screen');
                passwordInput.value = '';
            } else {
                errorEl.classList.remove('hidden');
            }
        }

        async function verifyCompanyAdminPassword() {
            const companyName = document.getElementById('company-login-select').value;
            const username = document.getElementById('admin-username-input').value.trim();
            const password = document.getElementById('admin-password-input').value.trim();
            const errorEl = document.getElementById('company-login-error');
            errorEl.classList.add('hidden');

            if (!companyName || !username || !password) {
                errorEl.textContent = 'Preencha todos os campos.';
                errorEl.classList.remove('hidden'); return;
            }
            const { data: company, error: companyError } = await supabaseClient.from('companies').select('id, name').eq('name', companyName).single();
            if (companyError || !company) {
                errorEl.textContent = 'Empresa não encontrada.';
                errorEl.classList.remove('hidden'); return;
            }
            const { data: admin, error: adminError } = await supabaseClient.from('company_admins').select('*').eq('company_id', company.id).eq('username', username).eq('password', password).single();
            if (adminError || !admin) {
                errorEl.textContent = 'Usuário ou senha incorretos.';
                errorEl.classList.remove('hidden');
            } else {
                state.loggedInCompany = company;
                state.loggedInAdmin = admin;
                await setupAdminScreen();
                showScreen('admin-screen');
                showAdminSubScreen('request-ride-screen');
                document.getElementById('admin-username-input').value = '';
                document.getElementById('admin-password-input').value = '';
            }
        }

        async function refreshAllUsers() {
            const { data: users, error: usersError } = await supabaseClient.from('users').select('id, name, company, address');
            if (usersError) { console.error("Erro refreshAllUsers:", usersError); return; }
            state.allUsers = users || [];
        }

        async function setupAdminScreen() {
            document.getElementById('admin-welcome-message').textContent = `Bem-vindo, ${state.loggedInAdmin.username} (${state.loggedInCompany.name})`;
            resetAdminForm();
            await refreshAllUsers();
            const passengerSelect = document.getElementById('passenger-quantity-select');
            passengerSelect.removeEventListener('change', handlePassengerQuantityChange);
            passengerSelect.addEventListener('change', handlePassengerQuantityChange);
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-request-ride').classList.add('active');
            document.querySelectorAll('.admin-sub-screen').forEach(scr => scr.classList.remove('active'));
            document.getElementById('request-ride-screen').classList.add('active');
        }

        function handlePassengerQuantityChange(event) {
            const quantity = parseInt(event.target.value, 10);
            const container = document.getElementById('collaborators-container');
            const rideDetails = document.getElementById('admin-ride-details');
            container.innerHTML = '';
            if (isNaN(quantity) || quantity < 1) {
                rideDetails.classList.add('hidden'); return;
            }
            rideDetails.classList.remove('hidden');
            const companyUsers = state.allUsers.filter(user => user.company === state.loggedInCompany.name).sort((a, b) => a.name.localeCompare(b.name));
            const optionsHtml = companyUsers.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
            let inputsHtml = '';
            for (let i = 0; i < quantity; i++) {
                inputsHtml += `
                    <div class="border border-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-md mb-2">Origem (Passageiro ${i + 1})</p>
                        <div class="mb-2">
                            <label for="collaborator-select-${i}" class="block mb-1 text-xs font-medium">Colaborador</label>
                            <select id="collaborator-select-${i}" data-index="${i}" class="w-full p-2 rounded-lg collaborator-selector"><option value="">-- Selecione --</option>${optionsHtml}</select>
                        </div>
                        <div class="autocomplete-container">
                            <label for="address-input-${i}" class="block mb-1 text-xs font-medium">Endereço</label>
                            <input type="text" id="address-input-${i}" class="w-full p-2 rounded-lg" placeholder="Endereço autocompletado ou manual">
                        </div>
                    </div>`;
            }
            inputsHtml += `
                <div class="border border-cyan-400 p-3 rounded-lg mt-4">
                    <p class="font-semibold text-md mb-2 text-cyan-400">Destino Final</p>
                    <div class="autocomplete-container">
                        <label for="address-input-destination" class="block mb-1 text-xs font-medium">Endereço de Destino</label>
                        <input type="text" id="address-input-destination" class="w-full p-2 rounded-lg" placeholder="Digite o endereço de destino da viagem">
                    </div>
                </div>`;
            container.innerHTML = inputsHtml;
            
            // Inicializa autocomplete APÓS renderizar
            requestAnimationFrame(() => {
                for (let i = 0; i < quantity; i++) {
                    const inputElement = document.getElementById(`address-input-${i}`);
                    if (inputElement) initAutocomplete(inputElement);
                }
                const destInputElement = document.getElementById('address-input-destination');
                 if (destInputElement) initAutocomplete(destInputElement);

                 document.querySelectorAll('.collaborator-selector').forEach(select => {
                    select.removeEventListener('change', handleCollaboratorSelection); // Evita duplicar
                    select.addEventListener('change', handleCollaboratorSelection);
                 });
            });
        }

        function handleCollaboratorSelection(event) {
            const selectedUserId = event.target.value;
            const index = event.target.dataset.index;
            const addressInput = document.getElementById(`address-input-${index}`);
            if (selectedUserId) {
                const selectedUser = state.allUsers.find(user => user.id == selectedUserId);
                addressInput.value = (selectedUser && selectedUser.address) ? selectedUser.address : '';
            } else {
                addressInput.value = '';
            }
        }

        function openAdminScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            const today = new Date();
            document.getElementById('schedule-date').min = today.toISOString().split('T')[0];
            document.getElementById('schedule-date').value = today.toISOString().split('T')[0];
            document.getElementById('schedule-time').value = today.toTimeString().slice(0, 5);
            modal.classList.add('flex');
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').classList.remove('flex');
        }

        function confirmAdminSchedule() {
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');
            if (!dateInput.value || !timeInput.value) { return alert('Selecione data e hora.'); }
            const scheduledDate = new Date(`${dateInput.value}T${timeInput.value}`);
            const now = new Date();
            const scheduledMinutes = Math.floor(scheduledDate.getTime() / 60000);
            const nowMinutes = Math.floor(now.getTime() / 60000);
            if (scheduledMinutes < nowMinutes) { return alert("Data/hora não pode ser no passado."); }
            adminScheduledDateTime = scheduledDate.toISOString();
            adminSelectedRequestType = 'scheduled';
            closeScheduleModal();
            adminRequestRide();
        }

        async function adminRequestRide() {
            const passengerCount = parseInt(document.getElementById('passenger-quantity-select').value, 10);
            if (!passengerCount || passengerCount < 1) { return alert('Selecione passageiros.'); }
            const firstCollaboratorId = document.getElementById('collaborator-select-0').value;
            if (!firstCollaboratorId) { return alert('Selecione Colaborador Origem 1.'); }
            const collaborator = state.allUsers.find(u => u.id == firstCollaboratorId);
            const originAddress = document.getElementById('address-input-0').value.trim();
            if (!originAddress) { return alert('Endereço Origem 1 obrigatório.'); }
            const destinationAddress = document.getElementById('address-input-destination').value.trim();
            if (!destinationAddress) { return alert('Endereço Destino Final obrigatório.'); }
            const destinationsArray = [];
            for (let i = 1; i < passengerCount; i++) {
                const collabId = document.getElementById(`collaborator-select-${i}`)?.value;
                const addressValue = document.getElementById(`address-input-${i}`)?.value.trim();
                if (!collabId || !addressValue) { return alert(`Preencha Colaborador e Endereço Origem ${i + 1}.`); }
                const additionalCollaborator = state.allUsers.find(u => u.id == collabId);
                destinationsArray.push({ name: `Origem: ${additionalCollaborator.name}`, address: addressValue });
            }
            destinationsArray.push({ name: 'Destino Final', address: destinationAddress });
            let rideData = {
                userId: collaborator.id, userName: collaborator.name, userCompany: collaborator.company,
                origin_address: originAddress, destination: JSON.stringify(destinationsArray),
                passenger_count: passengerCount, observation: document.getElementById('admin-observation').value.trim(),
                requestTime: new Date().toISOString(), requested_by_admin_name: state.loggedInAdmin.username,
            };
            if (adminSelectedRequestType === 'scheduled' && adminScheduledDateTime) {
                rideData.status = 'scheduled'; rideData.request_type = 'scheduled'; rideData.scheduled_datetime = adminScheduledDateTime;
            } else {
                rideData.status = 'approved'; rideData.request_type = 'immediate';
            }
            const { data, error } = await supabaseClient.from('rides').insert([rideData]).select().single();
            if (error) { alert('Erro: ' + error.message); }
            else { alert(`Corrida solicitada! Status: ${rideData.status}.`); resetAdminForm(); }
            adminSelectedRequestType = ''; adminScheduledDateTime = null;
        }

        async function populateLoginCompanies() {
            const select = document.getElementById('company-login-select');
            select.innerHTML = '<option value="">Carregando...</option>';
            const { data, error } = await supabaseClient.from('companies').select('id, name').order('name');
            if (error) { select.innerHTML = '<option value="">Erro</option>'; return; }
            if (!data || data.length === 0) { select.innerHTML = '<option value="">Nenhuma empresa</option>'; return; }
            select.innerHTML = '<option value="">-- Selecione --</option>' + data.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        function showAdminSubScreen(subScreenId) {
            document.querySelectorAll('.admin-sub-screen').forEach(screen => screen.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(subScreenId).classList.add('active');
            let tabToActivateId = '';
            if (subScreenId === 'request-ride-screen') {
                tabToActivateId = 'tab-request-ride';
                handlePassengerQuantityChange({ target: document.getElementById('passenger-quantity-select') });
            } else if (subScreenId === 'approval-ride-screen') {
                tabToActivateId = 'tab-approve-ride'; loadPendingRides();
            } else if (subScreenId === 'history-screen') {
                tabToActivateId = 'tab-history'; loadHistoryRides();
            } else if (subScreenId === 'user-management-screen') {
                tabToActivateId = 'tab-users'; loadCompanyUsers();
                initAutocomplete(document.getElementById('new-user-address')); // Init autocomplete here
            }
            const tabToActivate = document.getElementById(tabToActivateId);
            if (tabToActivate) tabToActivate.classList.add('active');
        }

        async function loadPendingRides() { /* ... (código existente sem alterações) ... */ }
        async function loadHistoryRides() { /* ... (código existente sem alterações) ... */ }
        async function approveRide(rideId) { /* ... (código existente sem alterações) ... */ }
        async function rejectRide(rideId) { /* ... (código existente sem alterações) ... */ }
        
        // --- initApp e subscriptions (sem alterações significativas) ---
        function initApp() {
            populateLoginCompanies();
            document.getElementById('admin-request-immediate-btn').onclick = () => { adminSelectedRequestType = 'immediate'; adminScheduledDateTime = null; adminRequestRide(); };
            document.getElementById('admin-request-scheduled-btn').onclick = openAdminScheduleModal;
             supabaseClient.channel('public:rides').on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, async (payload) => { /* ... (código existente) ... */ }).subscribe();
             supabaseClient.channel('public:users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, async (payload) => { /* ... (código existente) ... */ }).subscribe();
             supabaseClient.channel('public:companies').on('postgres_changes', { event: '*', schema: 'public', table: 'companies' }, async (payload) => { /* ... (código existente) ... */ }).subscribe();
        }
        document.addEventListener('DOMContentLoaded', initApp);

        // --- SUPER ADMIN CRUDs (sem alterações) ---
        async function loadCompanyManagement() { /* ... (código existente) ... */ }
        function editCompany(id, name) { /* ... (código existente) ... */ }
        function cancelEdit() { /* ... (código existente) ... */ }
        async function addOrUpdateCompany() { /* ... (código existente) ... */ }
        async function deleteCompany(id, name) { /* ... (código existente) ... */ }
        function manageAdminsForCompany(companyId, companyName) { /* ... (código existente) ... */ }
        async function loadCompanyAdmins() { /* ... (código existente) ... */ }
        function editCompanyAdmin(admin) { /* ... (código existente) ... */ }
        function cancelCompanyAdminEdit() { /* ... (código existente) ... */ }
        async function addOrUpdateCompanyAdmin() { /* ... (código existente) ... */ }
        async function deleteCompanyAdmin(id, username) { /* ... (código existente) ... */ }
        async function loadCompanyUsers() { /* ... (código existente) ... */ }
        function editUserById(userId) { /* ... (código existente) ... */ }
        function cancelUserEdit() { /* ... (código existente) ... */ }
        async function addOrUpdateUser() { /* ... (código existente) ... */ }
        async function deleteUser(id, name) { /* ... (código existente) ... */ }
    </script>
</body>
</html>
