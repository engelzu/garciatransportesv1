<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARCIA TRANSPORTES - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body, html { background-color: #000; }
        .main-gradient { background: linear-gradient(135deg, #000000, #000000); }
        .button-gradient { background: linear-gradient(to right, #000000, #000000); border: 2px solid white; position: relative; overflow: hidden; color: white !important; }
        .button-gradient::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0.3), rgba(255,255,255,0)); transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        .button-gradient:hover::before { transform: translateX(0); }
        .card-gradient { background: linear-gradient(135deg, #000000, #000000); border: 1px solid #4b5563; }
        .screen { display: none; background-color: #000; }
        .screen.active { display: block; }
        .text-black, .text-gray-800, .text-gray-400, .text-gray-300, .text-gray-600, .text-gray-700, .text-gray-500, .text-green-300, .text-yellow-300 { color: #ffffff !important; }
        .text-cyan-400 { color: #00ffff !important; }
        h1, h2, h3, p, button, label, input::placeholder, textarea::placeholder, select, option { color: #ffffff !important; }
        input, select, textarea { background-color: #374151 !important; border-color: #4b5563 !important; color: white !important; }
        input:focus, select:focus, textarea:focus { border-color: #00ffff !important; ring: none !important; outline: none !important; box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.5) !important; }
        #company-password-input { font-size: 14px; text-align: center; }
        #company-password-input::placeholder { text-align: center; }
        #app-container { position: relative; }
        #admin-access-icon:hover svg { stroke: #fff; }

        /* ESTILO PARA A LISTA DE SUGESTÕES MANUAL */
        .autocomplete-container { position: relative; }
        .suggestions-list {
            position: absolute; left: 0; right: 0;
            background-color: #374151;
            border: 1px solid #4b5563; border-top: none;
            border-radius: 0 0 0.5rem 0.5rem; /* rounded-lg */
            color: white; z-index: 1050;
            max-height: 200px; overflow-y: auto; margin-top: -1px;
            display: none; /* Começa escondido */
        }
        .suggestion-item { padding: 8px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #4b5563; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #4b5563; }
        /* FIM DO ESTILO DA LISTA */

        #schedule-modal { display: none; }
        #schedule-modal.flex { display: flex; }

        .tab-button { background-color: #374151; border: 1px solid #4b5563; padding: 10px 15px; cursor: pointer; transition: all 0.2s ease-in-out; border-radius: 8px; font-weight: 600; }
        .tab-button.active { background-color: #00ffff; color: #000 !important; border-color: #00ffff; }
        .admin-sub-screen { display: none; }
        .admin-sub-screen.active { display: block; }
    </style>
</head>
<body class="main-gradient text-white min-h-screen flex items-start justify-center p-4 pt-8">

    <div id="app-container" class="w-full max-w-md mx-auto">

        <div id="company-login-screen" class="screen active"> /* ... (código igual anterior) ... */ </div>
        <div id="super-admin-login-screen" class="screen"> /* ... (código igual anterior) ... */ </div>

        <div id="admin-screen" class="screen">
            <div class="flex justify-between items-center mb-6"> /* ... (código igual anterior) ... */ </div>
            <div class="flex flex-wrap justify-center gap-2 mb-6"> /* ... (código igual anterior) ... */ </div>

            <div id="request-ride-screen" class="admin-sub-screen active">
                 <h2 class="text-2xl font-bold text-center mb-4">Solicitar Corrida</h2>
                <div id="admin-request-form" class="card-gradient p-6 rounded-lg">
                    <div class="mb-4"> /* ... (select quantidade) ... */ </div>
                    <div id="collaborators-container" class="space-y-4">
                        </div>
                    <div id="admin-ride-details" class="hidden"> /* ... (observação e botões) ... */ </div>
                </div>
            </div>

            <div id="approval-ride-screen" class="admin-sub-screen"> /* ... */ </div>
            <div id="history-screen" class="admin-sub-screen"> /* ... */ </div>

            <div id="user-management-screen" class="admin-sub-screen">
                 <h2 class="text-2xl font-bold text-center mb-4">Gerenciar Usuários</h2>
                <div class="card-gradient p-4 rounded-lg mb-6">
                    <h3 id="user-form-title" class="text-lg font-semibold mb-2">Adicionar Usuário</h3>
                    <input type="hidden" id="editing-user-id">
                    <div class="space-y-2">
                        <input type="text" id="new-user-matricula" placeholder="Matrícula" class="w-full p-2 rounded-lg">
                        <input type="text" id="new-user-name" placeholder="Nome Completo" class="w-full p-2 rounded-lg">
                        <div class="autocomplete-container">
                            <label for="new-user-address" class="sr-only">Endereço</label>
                            <input type="text" id="new-user-address" placeholder="Endereço" class="w-full p-2 rounded-lg">
                            <div id="suggestions-new-user-address" class="suggestions-list"></div>
                        </div>
                        <input type="tel" id="new-user-phone" placeholder="Telefone" class="w-full p-2 rounded-lg">
                        <input type="text" id="new-user-password" placeholder="Senha" class="w-full p-2 rounded-lg">
                    </div>
                    <button onclick="addOrUpdateUser()" class="w-full py-2 font-semibold rounded-lg bg-green-600 hover:bg-green-700 mt-3">Salvar</button>
                    <button id="cancel-user-edit-btn" onclick="cancelUserEdit()" class="w-full py-2 font-semibold rounded-lg bg-gray-600 hover:bg-gray-700 mt-2 hidden">Cancelar Edição</button>
                </div>
                <div id="user-list-container" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div id="company-management-screen" class="screen"> /* ... */ </div>
        <div id="admin-management-screen" class="screen"> /* ... */ </div>

    </div>

    <div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4"> /* ... */ </div>

    <script>
        // ========================================================================
        // CONSTANTES GLOBAIS
        // ========================================================================
        const SUPABASE_URL = 'https://jowsbmuqbzxukbbxbeqv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvd3NibXVxYnp4dWtiYnhiZXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzA5NjQsImV4cCI6MjA3MTA0Njk2NH0.UMW2aQmuq0RiEHgody5StKEQzDjrKZnfUprDgDaMd1w';
        const GEOAPIFY_API_KEY = '3bd73ecada1d478a8c9473ad4115be38'; // Sua chave Geoapify
       
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
       
        let state = { loggedInCompany: null, loggedInAdmin: null, allUsers: [] };
        let adminSelectedRequestType = '';
        let adminScheduledDateTime = null;
        let companyUsersCache = [];
        let currentManagingCompany = { id: null, name: null };
        let debounceTimeout; // Para debouncing das chamadas fetch

        // ========================================================================
        // FUNÇÃO fetchSuggestions (Usa Fetch API)
        // ========================================================================
        async function fetchSuggestions(query, suggestionsListElement, inputElement) {
            if (!suggestionsListElement) return; // Segurança extra
            if (query.length < 3) {
                suggestionsListElement.innerHTML = '';
                suggestionsListElement.style.display = 'none';
                return;
            }
            const biasLocation = "-30.0346,-51.2177"; // Porto Alegre
            const url = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&apiKey=${GEOAPIFY_API_KEY}&filter=countrycode:br&lang=pt&bias=proximity:${biasLocation}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                suggestionsListElement.innerHTML = ''; // Limpa

                if (data.features && data.features.length > 0) {
                    data.features.forEach(feature => {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.textContent = feature.properties.formatted;
                        suggestionDiv.className = 'suggestion-item';
                        suggestionDiv.addEventListener('click', () => {
                            inputElement.value = feature.properties.formatted;
                            suggestionsListElement.innerHTML = '';
                            suggestionsListElement.style.display = 'none';
                            console.log("Selecionado:", feature.properties.formatted);
                        });
                        suggestionsListElement.appendChild(suggestionDiv);
                    });
                    suggestionsListElement.style.display = 'block'; // Mostra
                } else {
                    suggestionsListElement.style.display = 'none'; // Esconde
                }
            } catch (error) {
                console.error("Erro fetchSuggestions:", error);
                suggestionsListElement.innerHTML = '';
                suggestionsListElement.style.display = 'none';
            }
        }

        // ========================================================================
        // FUNÇÃO initAutocomplete (Agora usa Fetch API)
        // ========================================================================
        function initAutocomplete(inputElement) {
            if (!inputElement) return;

            // Encontra ou cria o elemento da lista de sugestões
            const suggestionsListId = `suggestions-${inputElement.id}`;
            let suggestionsListElement = document.getElementById(suggestionsListId);
            if (!suggestionsListElement) {
                 console.warn(`Criando elemento de lista #${suggestionsListId}`);
                 suggestionsListElement = document.createElement('div');
                 suggestionsListElement.id = suggestionsListId;
                 suggestionsListElement.className = 'suggestions-list';
                 inputElement.parentNode.appendChild(suggestionsListElement);
            }

            // Remove listener antigo para evitar duplicatas
            inputElement.removeEventListener('input', handleAutocompleteInput);
            inputElement.removeEventListener('focus', handleAutocompleteFocus);

            // Adiciona novo listener
            inputElement.addEventListener('input', handleAutocompleteInput);
            inputElement.addEventListener('focus', handleAutocompleteFocus);

            // Armazena a referência da lista no input
            inputElement.suggestionsListElement = suggestionsListElement;
        }

        // Handler para o evento 'input'
        function handleAutocompleteInput(event) {
            clearTimeout(debounceTimeout);
            const inputElement = event.target;
            const suggestionsListElement = inputElement.suggestionsListElement;
            const query = inputElement.value;
            if (suggestionsListElement) {
                 debounceTimeout = setTimeout(() => {
                    fetchSuggestions(query, suggestionsListElement, inputElement);
                }, 300);
            }
        }
        
        // Handler para o evento 'focus'
        function handleAutocompleteFocus(event) {
            const inputElement = event.target;
            const suggestionsListElement = inputElement.suggestionsListElement;
            // Mostra a lista se já houver sugestões (evita chamar API só por focar)
            if (inputElement.value.length >= 3 && suggestionsListElement && suggestionsListElement.children.length > 0) {
                 suggestionsListElement.style.display = 'block';
            }
        }

        // Listener global para fechar listas ao clicar fora
        document.addEventListener('click', (event) => {
            document.querySelectorAll('.autocomplete-container').forEach(container => {
                if (!container.contains(event.target)) {
                    const list = container.querySelector('.suggestions-list');
                    if (list) list.style.display = 'none';
                }
            });
        });

        // ========================================================================
        // FUNÇÃO parseDestinations (sem alterações)
        // ========================================================================
        function parseDestinations(destinationString) { /* ... (código igual anterior) ... */ }
       
        function resetAdminForm() { /* ... */ }
        function showScreen(screenId) { /* ... */ }
        function logout() { /* ... */ }
        function showSuperAdminLogin() { /* ... */ }
        async function verifySuperAdminPassword() { /* ... */ }
        async function verifyCompanyAdminPassword() { /* ... */ }
        async function refreshAllUsers() { /* ... */ }
        async function setupAdminScreen() { /* ... */ }
        
        // ========================================================================
        // FUNÇÃO handlePassengerQuantityChange (Chama novo initAutocomplete)
        // ========================================================================
        function handlePassengerQuantityChange(event) {
            const quantity = parseInt(event.target.value, 10);
            const container = document.getElementById('collaborators-container');
            const rideDetails = document.getElementById('admin-ride-details');
            container.innerHTML = '';
            if (isNaN(quantity) || quantity < 1) {
                rideDetails.classList.add('hidden'); return;
            }
            rideDetails.classList.remove('hidden');
            const companyUsers = state.allUsers.filter(user => user.company === state.loggedInCompany.name).sort((a, b) => a.name.localeCompare(b.name));
            const optionsHtml = companyUsers.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
            let inputsHtml = '';
            // Cria HTML para os inputs de ORIGEM
            for (let i = 0; i < quantity; i++) {
                inputsHtml += `
                    <div class="border border-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-md mb-2">Origem (Passageiro ${i + 1})</p>
                        <div class="mb-2"> /* ... (select colaborador) ... */ </div>
                        <div class="autocomplete-container">
                            <label for="address-input-${i}" class="block mb-1 text-xs font-medium">Endereço</label>
                            <input type="text" id="address-input-${i}" class="w-full p-2 rounded-lg" placeholder="Digite o endereço">
                            <div id="suggestions-address-input-${i}" class="suggestions-list"></div> </div>
                    </div>`;
            }
            // Cria HTML para o input de DESTINO FINAL
            inputsHtml += `
                <div class="border border-cyan-400 p-3 rounded-lg mt-4">
                    <p class="font-semibold text-md mb-2 text-cyan-400">Destino Final</p>
                    <div class="autocomplete-container">
                        <label for="address-input-destination" class="block mb-1 text-xs font-medium">Endereço de Destino</label>
                        <input type="text" id="address-input-destination" class="w-full p-2 rounded-lg" placeholder="Digite o endereço">
                        <div id="suggestions-address-input-destination" class="suggestions-list"></div> </div>
                </div>`;
            container.innerHTML = inputsHtml;
            
            // Inicializa autocomplete APÓS renderizar
            requestAnimationFrame(() => {
                for (let i = 0; i < quantity; i++) {
                    const inputElement = document.getElementById(`address-input-${i}`);
                    if (inputElement) initAutocomplete(inputElement); // Chama a nova função
                }
                const destInputElement = document.getElementById('address-input-destination');
                 if (destInputElement) initAutocomplete(destInputElement); // Chama a nova função

                 document.querySelectorAll('.collaborator-selector').forEach(select => {
                    select.removeEventListener('change', handleCollaboratorSelection);
                    select.addEventListener('change', handleCollaboratorSelection);
                 });
            });
        }
        
        function handleCollaboratorSelection(event) { /* ... */ }
        function openAdminScheduleModal() { /* ... */ }
        function closeScheduleModal() { /* ... */ }
        function confirmAdminSchedule() { /* ... */ }
        async function adminRequestRide() { /* ... */ }
        async function populateLoginCompanies() { /* ... */ }
       
        function showAdminSubScreen(subScreenId) {
            document.querySelectorAll('.admin-sub-screen').forEach(screen => screen.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(subScreenId)?.classList.add('active');
            let tabToActivateId = '';
            if (subScreenId === 'request-ride-screen') {
                tabToActivateId = 'tab-request-ride';
                handlePassengerQuantityChange({ target: document.getElementById('passenger-quantity-select') });
            } else if (subScreenId === 'approval-ride-screen') {
                tabToActivateId = 'tab-approve-ride'; loadPendingRides();
            } else if (subScreenId === 'history-screen') {
                tabToActivateId = 'tab-history'; loadHistoryRides();
            } else if (subScreenId === 'user-management-screen') {
                tabToActivateId = 'tab-users'; loadCompanyUsers();
                const newUserAddressInput = document.getElementById('new-user-address');
                if (newUserAddressInput) initAutocomplete(newUserAddressInput); // Chama a nova função
            }
            const tabToActivate = document.getElementById(tabToActivateId);
            if (tabToActivate) tabToActivate.classList.add('active');
        }
       
        async function loadPendingRides() { /* ... (código igual anterior) ... */ }
        async function loadHistoryRides() { /* ... (código igual anterior) ... */ }
        async function approveRide(rideId) { /* ... (código igual anterior) ... */ }
        async function rejectRide(rideId) { /* ... (código igual anterior) ... */ }
        
        // --- initApp e subscriptions ---
        function initApp() {
            console.log("Executando initApp..."); // Log inicial
            // REMOVIDA a verificação de 'Autocomplete' pois não usamos mais a biblioteca

            populateLoginCompanies();
            document.getElementById('admin-request-immediate-btn').onclick = () => { adminSelectedRequestType = 'immediate'; adminScheduledDateTime = null; adminRequestRide(); };
            document.getElementById('admin-request-scheduled-btn').onclick = openAdminScheduleModal;
            
             // Configura subscriptions
             supabaseClient.channel('public:rides').on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, async (payload) => { /* ... (código existente) ... */ }).subscribe();
             supabaseClient.channel('public:users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, async (payload) => { /* ... (código existente) ... */ }).subscribe();
             supabaseClient.channel('public:companies').on('postgres_changes', { event: '*', schema: 'public', table: 'companies' }, async (payload) => { /* ... (código existente) ... */ }).subscribe();
        }
        document.addEventListener('DOMContentLoaded', initApp); // Chama initApp após DOM carregar

        // --- SUPER ADMIN CRUDs ---
        async function loadCompanyManagement() { /* ... (código existente) ... */ }
        function editCompany(id, name) { /* ... (código existente) ... */ }
        function cancelEdit() { /* ... (código existente) ... */ }
        async function addOrUpdateCompany() { /* ... (código existente) ... */ }
        async function deleteCompany(id, name) { /* ... (código existente) ... */ }
        function manageAdminsForCompany(companyId, companyName) { /* ... (código existente) ... */ }
        async function loadCompanyAdmins() { /* ... (código existente) ... */ }
        function editCompanyAdmin(admin) { /* ... (código existente) ... */ }
        function cancelCompanyAdminEdit() { /* ... (código existente) ... */ }
        async function addOrUpdateCompanyAdmin() { /* ... (código existente) ... */ }
        async function deleteCompanyAdmin(id, username) { /* ... (código existente) ... */ }
        async function loadCompanyUsers() { /* ... (código existente) ... */ }
        
        function editUserById(userId) {
            const user = companyUsersCache.find(u => u.id === userId);
            if (!user) return alert('Usuário não encontrado');
            document.getElementById('editing-user-id').value = user.id;
            document.getElementById('new-user-matricula').value = user.matricula || '';
            document.getElementById('new-user-name').value = user.name || '';
            document.getElementById('new-user-address').value = user.address || '';
            document.getElementById('new-user-phone').value = user.phone || '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-password').placeholder = 'Nova Senha (deixe em branco para manter)';
            document.getElementById('cancel-user-edit-btn').classList.remove('hidden');
            document.getElementById('user-form-title').textContent = 'Editar Usuário';
            window.scrollTo(0, 0);
            
            // Inicializa autocomplete no campo de endereço
            const addressInput = document.getElementById('new-user-address');
            if(addressInput) initAutocomplete(addressInput); // Chama a nova função
        }

        function cancelUserEdit() {
             document.getElementById('editing-user-id').value = '';
             document.getElementById('new-user-matricula').value = '';
             document.getElementById('new-user-name').value = '';
             document.getElementById('new-user-address').value = '';
             document.getElementById('new-user-phone').value = '';
             document.getElementById('new-user-password').value = '';
             document.getElementById('new-user-password').placeholder = 'Senha';
             document.getElementById('cancel-user-edit-btn').classList.add('hidden');
             document.getElementById('user-form-title').textContent = 'Adicionar Usuário';
             
             // Re-inicializa para o modo "adicionar"
             const addressInput = document.getElementById('new-user-address');
             if(addressInput) initAutocomplete(addressInput); // Chama a nova função
        }
        
        async function addOrUpdateUser() { /* ... (código existente) ... */ }
        async function deleteUser(id, name) { /* ... (código existente) ... */ }
    </script>
</body>
</html>
