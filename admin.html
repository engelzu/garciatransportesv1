<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GARCIA TRANSPORTES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/resend@3.2.0/dist/index.global.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@geoapify/geocoder-autocomplete@2.0.1/dist/themes/minimal.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@geoapify/geocoder-autocomplete@2.0.1/dist/index.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
        /* GRADIENTE DE FUNDO ALTERADO */
        .main-gradient {
             background: linear-gradient(to bottom, #a0feff, #c3e6ff, #e6c3ff, #ffc3f2); /* Ciano -> Azul claro -> Roxo claro -> Rosa claro */
        }
        .button-gradient {
            background: linear-gradient(to right, #6d28d9, #4f46e5);
        }
        .button-gradient:hover {
            background: linear-gradient(to right, #4f46e5, #6d28d9);
        }
        /* Ajuste para botões do admin terem fundo sólido para melhor contraste com novo gradiente */
        #admin-screen button:not([onclick^="logout"]), #admin-screen a {
            background-color: #374151; /* Cinza escuro */
            color: white;
            border: 1px solid #4b5563;
        }
        #admin-screen button:not([onclick^="logout"]):hover, #admin-screen a:hover {
            background-color: #4b5563; /* Cinza um pouco mais claro */
        }
        .card-gradient {
             background: linear-gradient(135deg, #1f2937, #374151);
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #6d28d9;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ESTILO PARA O AUTOCOMPLETE DO GEOAPIFY */
        .geoapify-autocomplete-input {
             color: white !important;
             background-color: #1f2937 !important; /* Fundo do input */
             border: 1px solid #4b5563 !important;
        }
        .geoapify-autocomplete-items {
            background-color: #374151 !important; /* Fundo da lista dropdown */
            border: 1px solid #4b5563 !important;
            color: white !important;
        }
        .geoapify-autocomplete-items div:hover {
            background-color: #4b5563 !important; /* Cor do item em hover */
        }
        .geoapify-autocomplete-item {
             color: white !important;
        }
        .geoapify-autocomplete-item.active {
            background-color: #4f46e5 !important; /* Cor do item selecionado */
        }
        /* FIM DO ESTILO DO AUTOCOMPLETE */
        
        #heatmap-canvas {
            height: 70vh; /* Você já tinha isso, mas garantindo */
            width: 100%;
            border-radius: 0.5rem;
            border: 2px solid #4f46e5;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ef4444;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #22c55e;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Custom styles for status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Full rounded corners */
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            text-align: center;
        }
        .status-requested { background-color: #2563eb; color: #ffffff; } /* Blue */
        .status-assigned { background-color: #f59e0b; color: #ffffff; } /* Amber */
        .status-accepted { background-color: #10b981; color: #ffffff; } /* Emerald */
        .status-arrived_pickup { background-color: #d946ef; color: #ffffff; } /* Fuchsia */
        .status-in_progress { background-color: #8b5cf6; color: #ffffff; } /* Violet */
        .status-completed { background-color: #10b981; color: #ffffff; } /* Emerald */
        .status-canceled { background-color: #ef4444; color: #ffffff; } /* Red */
        .status-pending_approval { background-color: #a16207; color: #ffffff; } /* Yellow-700 */
        .status-approved { background-color: #0d9488; color: #ffffff; } /* Teal-600 */
        .status-rejected { background-color: #991b1b; color: #ffffff; } /* Red-800 */

        #initial-screen button[onclick="showScreen('user-login-screen')"],
        #initial-screen button[onclick="showScreen('driver-selection-screen')"] {
            display: none;
        }

        /* Ajuste de cor de texto para melhor leitura no novo fundo */
        body {
             color: #1f2937; /* Cinza bem escuro para textos gerais */
        }
        h1, h2, h3, h4, label, button, a {
            color: #1f2937; /* Garante que títulos, labels e botões também usem a cor escura */
        }
        button[onclick^="showScreen"], #admin-login-screen label, #user-login-screen label, #driver-selection-screen h2, #initial-screen h1, #initial-screen p {
             color: #1f2937;
        }
         #initial-screen button span, #initial-screen button svg {
            color: white !important; /* Mantém ícones e texto dos botões iniciais brancos */
        }
         button.text-yellow-300 {
             color: #4f46e5 !important; /* Botões "Voltar" terão cor roxa */
         }
         #admin-login-error, #user-login-error {
             color: #dc2626; /* Vermelho para erros */
         }
         /* Cor dos textos dentro dos cards e tabelas permanece branca */
         .card-gradient, .card-gradient p, .card-gradient h3, .card-gradient span, .card-gradient label,
         #admin-requests-list span, #admin-requests-list p, #admin-requests-list h4,
         #admin-ongoing-rides-table th, #admin-ongoing-rides-table td,
         #driver-crud-list th, #driver-crud-list td,
         #user-crud-list th, #user-crud-list td,
         #driver-jobs-list p, #driver-jobs-list span,
         #user-ride-history th, #user-ride-history td,
         #driver-ride-history th, #driver-ride-history td,
         #all-records-table th, #all-records-table td,
         #modal p, #modal label, #modal button, #modal select option {
             color: white;
         }
         #modal input, #modal select {
             color: white; /* Garante texto branco nos inputs do modal */
         }
         #modal input::placeholder {
             color: #9ca3af; /* Placeholder cinza claro */
         }
         #admin-ongoing-rides-table .text-yellow-300, #admin-requests-list .text-yellow-300 {
              color: #facc15 !important; /* Amarelo para observações */
         }
         #admin-ongoing-rides-table .text-red-400, #admin-requests-list .text-red-400 {
              color: #f87171 !important; /* Vermelho para erros de distância */
         }
         #user-status-message, #available-drivers-count {
             color: #1f2937; /* Texto de status do usuário e motoristas disponíveis */
         }
         #driver-name-display, #driver-stats-display, #driver-status-label {
              color: #1f2937; /* Ajusta textos na tela do motorista */
         }
         #driver-status-label.text-green-400 { color: #22c55e !important; } /* Mantém cores de status */
         #driver-status-label.text-red-400 { color: #ef4444 !important; } /* Mantém cores de status */

         /* Estilo para inputs de data/hora */
        input[type="date"], input[type="datetime-local"] {
            color-scheme: dark; /* Garante que o calendário interno tenha cores escuras */
        }
         
        /* Corrige o input de autocomplete para ficar dentro do card */
        .autocomplete-container {
            position: relative;
        }

    </style>
</head>
<body class="main-gradient text-white min-h-screen flex items-center justify-center p-4">

    <audio id="admin-ringtone" preload="auto" src="SOM/somchamada.mp3"></audio>

    <div id="countdown-timer" class="fixed top-4 right-4 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded-full"></div>

    <div id="app-container" class="w-full max-w-full mx-auto px-4 sm:px-6 lg:px-8">

        <div id="initial-screen" class="screen active text-center">
            <div class="flex justify-center items-center gap-4 mb-2">
                <div id="app-icon-container" class="h-12 w-12"></div>
                <h1 class="text-4xl sm:text-5xl font-bold text-black">GARCIA TRANSPORTE</h1>
            </div>

            <p class="mb-12 text-gray-800">Sua viagem segura e rápida.</p>
            <div class="space-y-4 max-w-md mx-auto">
                <button onclick="showScreen('admin-login-screen')" class="w-full flex items-center justify-center gap-3 py-4 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg transform hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.602-3.751m-.228-1.024A11.953 11.953 0 0012 2.75a11.953 11.953 0 00-8.172 3.024" />
                    </svg>
                    <span>ÁREA DO ADMIN</span>
                </button>
                <button onclick="showScreen('user-login-screen')" class="w-full flex items-center justify-center gap-3 py-4 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg transform hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>PASSAGEIRO</span>
                </button>
                <button onclick="showScreen('driver-selection-screen')" class="w-full flex items-center justify-center gap-3 py-4 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg transform hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6m-6 0v-2a1 1 0 011-1h2a1 1 0 011 1v2m-6 0h6" />
                    </svg>
                   <span>MOTORISTA</span>
                </button>
            </div>
        </div>

        <div id="admin-login-screen" class="screen">
            <button onclick="showScreen('initial-screen')" class="mb-4 text-yellow-300">← Voltar</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Login Administrador</h2>
             <div class="max-w-md mx-auto">
                <div class="mb-4">
                    <label for="admin-password" class="block mb-2 text-sm font-medium">Senha</label>
                    <input type="password" id="admin-password" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite a senha">
                </div>
                <button onclick="loginAdmin()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg text-white">ENTRAR</button>
                <p id="admin-login-error" class="text-red-500 text-center mt-4 hidden">Senha incorreta!</p>
            </div>
        </div>

        <div id="user-login-screen" class="screen">
            <button onclick="showScreen('initial-screen')" class="mb-4 text-yellow-300">← Voltar</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Login do Usuário</h2>
            <div class="max-w-md mx-auto">
                <div class="mb-4">
                    <label for="user-id" class="block mb-2 text-sm font-medium">Matrícula</label>
                    <input type="text" id="user-id" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite sua matrícula">
                </div>
                <div class="mb-4">
                    <label for="user-password" class="block mb-2 text-sm font-medium">Senha</label>
                    <input type="password" id="user-password" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite sua senha">
                </div>
                <button onclick="loginUser()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg text-white">ENTRAR</button>
                <p id="user-login-error" class="text-red-500 text-center mt-4 hidden">Matrícula ou senha incorreta!</p>
            </div>
        </div>

        <div id="driver-selection-screen" class="screen">
            <button onclick="showScreen('initial-screen')" class="mb-4 text-yellow-300">← Voltar</button>
            <h2 class="text-3xl font-bold mb-1 text-center">Selecionar Motorista</h2>
            <p id="driver-selection-timestamp" class="text-center text-gray-700 text-sm mb-6"></p>
            <div id="driver-list-selection" class="space-y-3 max-w-md mx-auto">
                </div>
        </div>

        <div id="user-screen" class="screen">
             <div class="max-w-md mx-auto">
                <button onclick="logout()" class="mb-4 text-yellow-300">← Sair</button>
                <h2 class="text-3xl font-bold mb-6 text-center">Área do Usuário</h2>

                <div id="user-request-form" class="card-gradient p-4 rounded-lg mb-6">
                    <h3 class="font-semibold mb-2 text-xl">Solicitar uma Viagem</h3>
                    <p id="available-drivers-count" class="text-center mb-4 text-lg text-green-800 font-semibold"></p>

                    <div class="mb-4 autocomplete-container">
                        <label for="origin" class="block mb-2 text-sm font-medium">Qual a sua origem?</label>
                        <input type="text" id="origin" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite o endereço de partida completo">
                    </div>

                    <div class="mb-4 autocomplete-container">
                        <label for="destination" class="block mb-2 text-sm font-medium">Qual o seu destino?</label>
                        <input type="text" id="destination" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" placeholder="Digite o endereço completo">
                    </div>

                    <div class="flex items-center mb-4">
                        <input id="schedule-toggle" type="checkbox" onchange="document.getElementById('schedule-datetime-container').classList.toggle('hidden')" class="h-4 w-4 rounded border-gray-300 text-yellow-300 focus:ring-yellow-300">
                        <label for="schedule-toggle" class="ml-2 block text-sm text-gray-300">Agendar para mais tarde?</label>
                    </div>
                    <div id="schedule-datetime-container" class="hidden mb-4">
                        <label for="schedule-datetime" class="block mb-2 text-sm font-medium">Data e Hora do Agendamento</label>
                        <input type="datetime-local" id="schedule-datetime" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 focus:ring-2 focus:ring-yellow-300 focus:outline-none text-white" style="color-scheme: dark;">
                    </div>

                    <button onclick="requestRide()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg button-gradient shadow-lg transform hover:scale-105 transition-transform text-white">
                        SOLICITAR TAXI
                    </button>
                </div>

                <div id="user-status" class="hidden mt-8 text-center">
                    <div id="status-icon-searching" class="hidden mx-auto mb-2">
                        <div class="loader mx-auto"></div>
                    </div>
                    <div id="status-icon-en-route" class="hidden mx-auto mb-2">
                        </div>
                    <div id="status-icon-arrived-pickup" class="hidden mx-auto mb-2">
                        </div>
                    <div id="status-icon-in-progress" class="hidden mx-auto mb-2">
                        </div>
                    <p id="user-status-message" class="mt-4 text-lg"></p>
                    <button id="cancel-ride-btn" onclick="cancelRide()" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg bg-red-600 hover:bg-red-700 text-white">CANCELAR SOLICITAÇÃO</button>
                </div>
                <div class="card-gradient p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-xl">Minhas Solicitações</h3>
                        <button onclick="exportUserRidesToExcel()" class="py-1 px-3 text-sm font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">Exportar</button>
                    </div>
                    <div id="user-ride-history" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <div id="admin-screen" class="screen">
             <img src="logogarcia.jpeg" alt="Logo Garcia Transportes" class="mx-auto mb-6 h-20 w-auto">
             
             <button onclick="logout()" class="mb-4 text-yellow-300">← Sair e Voltar à Tela Inicial</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Painel do Administrador</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                <button onclick="showScreen('admin-driver-crud-screen')" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-lg flex flex-col items-center gap-2 card-gradient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <span>Gerenciar Motoristas</span>
                </button>
                <button onclick="showScreen('admin-user-crud-screen')" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-lg flex flex-col items-center gap-2 card-gradient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span>Gerenciar Usuários</span>
                </button>
                <button onclick="showScreen('admin-requests-screen')" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-lg flex flex-col items-center gap-2 card-gradient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    <span>Solicitações</span>
                </button>
                <button onclick="showScreen('admin-heatmap-screen')" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-lg flex flex-col items-center gap-2 card-gradient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    <span>Mapa de Calor</span>
                </button>
                <button onclick="showScreen('admin-customize-screen')" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-lg flex flex-col items-center gap-2 card-gradient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Personalizar</span>
                </button>
                <button onclick="openRecordsTab()" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-lg flex flex-col items-center gap-2 card-gradient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Registros</span>
                </button>
                <a href="https://dashboard-with-supabase.lumi.ing" target="_blank" rel="noopener noreferrer" class="w-full py-3 px-6 text-lg font-semibold rounded-lg shadow-lg text-center flex flex-col items-center gap-2 card-gradient">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
            </div>
</div>

        <div id="admin-requests-screen" class="screen">
            <div class="flex justify-between items-center mb-4">
                <button onclick="promptToGoBack()" class="text-yellow-300">← Voltar ao Painel</button>
                <h2 class="text-3xl font-bold text-center">Painel de Corridas</h2>
                <div class="w-32"></div> </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                 <div class="card-gradient p-3 rounded-lg w-full" style="height: fit-content;">
<h3 class="font-semibold mb-2 text-center">Status das Corridas</h3>
                    <div class="flex justify-around text-center flex-wrap gap-2">
                        <div>
                            <p class="text-2xl font-bold text-orange-400" id="status-agendada-count">0</p>
                            <p class="text-xs text-gray-300">Agendada</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-blue-400" id="status-solicitado-count">0</p>
                            <p class="text-xs text-gray-300">Solicitado</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-yellow-400" id="status-designado-count">0</p>
                            <p class="text-xs text-gray-300">Designado</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-purple-400" id="status-em-andamento-count">0</p>
                            <p class="text-xs text-gray-300">Em Andamento</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-400" id="status-concluidas-count">0</p>
                            <p class="text-xs text-gray-300">Concluídas</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-600 text-center">
                        <div id="digital-clock" class="text-3xl font-mono text-cyan-300 mb-2">00:00:00</div>
<button onclick="exportDailyReportNow()" class="w-full py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">
                            EXPORTAR
                        </button>
</div>
                </div>
                <div class="card-gradient p-3 rounded-lg w-full lg:col-span-2" style="height: fit-content;">
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div>
                            <h3 class="font-semibold text-2xl mb-4">Motoristas</h3>
                    <div class="space-y-1 text-base">
<p>Total: <span id="total-drivers-count" class="font-bold">0</span></p>
                                <p class="text-green-400">Ativos: <span id="active-drivers-count" class="font-bold">0</span></p>
                                <p class="text-red-400">Inativos: <span id="inactive-drivers-count" class="font-bold">0</span></p>
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-4">
                    <div class="w-32 h-32">
<canvas id="driver-status-chart"></canvas>
                            </div>
                            <button onclick="showScreen('admin-driver-crud-screen')" class="w-full py-2 px-3 text-sm font-semibold rounded-lg button-gradient text-white">
Gerenciar Motoristas
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 max-h-[calc(100vh-250px)] overflow-y-auto pr-2">
<div class="lg:col-span-1">
                    <h3 class="text-2xl font-bold mb-4">Novas Solicitações</h3>
                    <div id="admin-requests-list" class="space-y-4">
                        </div>
                </div>

                <div class="lg:col-span-2">
                    <h3 class="text-2xl font-bold mb-4">Corridas em Andamento</h3>
                    <div id="admin-ongoing-rides-table" class="card-gradient p-4 rounded-lg overflow-x-auto">
                        </div>
                </div>
            </div>
        </div>

        <div id="admin-driver-crud-screen" class="screen">
            <button onclick="showScreen('admin-screen')" class="mb-4 text-yellow-300">← Voltar ao Painel</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Cadastro de Motoristas</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card-gradient p-4 rounded-lg">
                    <h3 class="font-semibold mb-2">Adicionar Novo Motorista</h3>
                    <input type="text" id="new-driver-name" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Nome Completo">
                    <input type="tel" id="new-driver-phone" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Telefone">
                    <input type="text" id="new-driver-plate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Placa do Carro">
                    <input type="text" id="new-driver-model" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Modelo do Carro">
                    <input type="text" id="new-driver-color" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Cor do Carro">
                    <input type="password" id="new-driver-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Senha">
                    <button onclick="addDriver()" class="w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">Adicionar</button>
                </div>
                <div class="card-gradient p-4 rounded-lg md:col-span-2">
                    <h3 class="font-semibold mb-4">Motoristas Cadastrados</h3>
                    <div id="driver-crud-list" class="max-h-[60vh] overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <div id="admin-user-crud-screen" class="screen">
            <button onclick="showScreen('admin-screen')" class="mb-4 text-yellow-300">← Voltar ao Painel</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Cadastro de Usuários</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-6">
                    <div class="card-gradient p-4 rounded-lg">
                        <h3 class="font-semibold mb-2">Importar Usuários (Excel)</h3>
                        <p class="text-sm text-gray-300 mb-3">Baixe o template, preencha e faça o upload.</p>
                        <div class="flex gap-2 mb-3">
                            <button onclick="downloadUserTemplate()" class="w-full py-2 px-4 font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Baixar Template</button>
                        </div>
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        <button onclick="importUsersFromExcel()" class="w-full mt-3 py-2 px-4 font-semibold rounded-lg button-gradient text-white">Importar Arquivo</button>
                    </div>
                     <div class="card-gradient p-4 rounded-lg">
                        <h3 class="font-semibold mb-2">Adicionar Novo Usuário</h3>
                        <input type="text" id="new-user-id" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Matrícula">
                        <input type="text" id="new-user-name" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Nome Completo">
                        <input type="password" id="new-user-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Senha">
                        <input type="text" id="new-user-company" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Empresa">
                        
                        <div class="autocomplete-container">
                            <input type="text" id="new-user-address" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Endereço">
                        </div>
                        
                        <input type="tel" id="new-user-phone" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none mb-2 text-white" placeholder="Telefone">
                        <button onclick="addUser()" class="w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">Adicionar</button>
                    </div>
                </div>

                <div class="card-gradient p-4 rounded-lg md:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-xl">
                            Usuários Cadastrados (<span id="user-count">0</span>)
                        </h3>
                        <button onclick="exportUsersToExcel()" class="py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-sm text-white">
                            Exportar Excel
                        </button>
                    </div>
                    <div id="user-crud-list" class="max-h-[60vh] overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <div id="admin-heatmap-screen" class="screen">
            <button onclick="showScreen('admin-screen')" class="mb-4 text-yellow-300">← Voltar ao Painel</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Mapa de Localização de Usuários</h2>
            <div id="heatmap-canvas"></div> 
        </div>

        <div id="admin-customize-screen" class="screen">
            <button onclick="showScreen('admin-screen')" class="mb-4 text-yellow-300">← Voltar ao Painel</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Personalizar App</h2>
            <div class="card-gradient p-4 rounded-lg max-w-md mx-auto">
                <h3 class="font-semibold mb-2">Ícone do Aplicativo</h3>
                <p class="text-sm text-gray-300 mb-3">Faça o upload de uma imagem para ser o ícone na tela inicial (recomendado: PNG transparente).</p>
                <input type="file" id="icon-file-input" accept="image/*" onchange="uploadAppIcon()" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
            </div>
        </div>

        <div id="driver-screen" class="screen">
            <div class="max-w-md mx-auto">
                <button onclick="showScreen('driver-selection-screen')" class="mb-4 text-yellow-300">← Trocar Motorista</button>
                <h2 class="text-3xl font-bold mb-2 text-center">Minhas Corridas</h2>
                <p id="driver-name-display" class="text-center mb-1"></p>
                <p id="driver-stats-display" class="text-center font-semibold text-sm mb-6"></p>
                <div class="flex items-center justify-between mb-4 card-gradient p-3 rounded-lg">
                    <span class="font-semibold text-lg">Meu Status</span>
                    <div class="flex items-center gap-3">
                        <span id="driver-status-label" class="font-bold"></span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="driver-status-toggle" onchange="toggleDriverStatus()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <button id="silence-btn" onclick="stopBeeping()" class="hidden w-full mb-4 py-2 px-4 font-semibold rounded-lg bg-yellow-500 text-gray-900">Silenciar Alerta</button>
                <div id="driver-jobs-list" class="space-y-4"></div>
                <div class="card-gradient p-4 rounded-lg mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-xl">Histórico de Corridas</h3>
                        <button onclick="exportDriverRidesToExcel()" class="py-1 px-3 text-sm font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">Exportar</button>
                    </div>
                    <div id="driver-ride-history" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>

        <div id="admin-records-screen" class="screen">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showScreen('admin-screen')" class="text-yellow-300">← Voltar ao Painel</button>
                <h2 class="text-3xl font-bold text-center">Todos os Registros</h2>
                <div class="w-32"></div> </div>

            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <div>
                    <label for="records-start-date" class="block mb-2 text-sm font-medium">Data Inicial</label>
                    <input type="date" id="records-start-date" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-white" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="records-end-date" class="block mb-2 text-sm font-medium">Data Final</label>
                    <input type="date" id="records-end-date" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-white" style="color-scheme: dark;">
                </div>
                <div>
                    <label for="records-company-filter" class="block mb-2 text-sm font-medium">Selecione a Empresa</label>
                    <select id="records-company-filter" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none min-w-[200px] text-white">
                        <option value="" class="text-gray-400">Todas as Empresas</option>
                        </select>
                </div>
                <div class="flex items-end gap-2">
                     <button onclick="filterRecords()" class="py-2 px-4 font-semibold rounded-lg button-gradient h-fit text-white">Filtrar</button>
                     <button onclick="clearRecordsFilter()" class="py-2 px-4 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600 h-fit text-white">Limpar Filtro</button>
                     <button onclick="exportRecordsToExcel()" class="py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 h-fit text-white">Exportar Excel</button>
                </div>
            </div>
            <div class="card-gradient p-4 rounded-lg overflow-x-auto">
                <table id="all-records-table" class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-900/30 sticky top-0">
                        <tr>
                            <th scope="col" class="px-4 py-3">Data Solicitação</th>
                            <th scope="col" class="px-4 py-3">Usuário</th>
                            <th scope="col" class="px-4 py-3">Empresa</th>
                            <th scope="col" class="px-4 py-3">Origem</th>
                            <th scope="col" class="px-4 py-3">Destino</th>
                            <th scope="col" class="px-4 py-3">Observação</th>
                            <th scope="col" class="px-4 py-3">Motorista</th>
                            <th scope="col" class="px-4 py-3">Status</th>
                            <th scope="col" class="px-4 py-3">Distância (km)</th>
                        </tr>
                    </thead>
                    <tbody id="all-records-body">
                        </tbody>
                </table>
            </div>
        </div>
        </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
            <p id="modal-message" class="mb-4 text-lg"></p>
            <div id="modal-input-container" class="hidden mb-4 space-y-2">
                <input type="text" id="modal-input-matricula" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Matrícula">
                <input type="text" id="modal-input-name" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Nome">
                <input type="tel" id="modal-input-phone" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Telefone">
                <input type="text" id="modal-input-plate" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Placa do Carro">
                <input type="text" id="modal-input-model" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Modelo do Carro">
                <input type="text" id="modal-input-color" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Cor do Carro">
                <input type="password" id="modal-input-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Nova Senha (deixe em branco para manter)">
                <select id="modal-input-status" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none">
                    <option value="active">Ativo</option>
                    <option value="inactive">Inativo</option>
                </select>
                <input type="text" id="modal-input-company" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Empresa">
                <div class="autocomplete-container">
                    <input type="text" id="modal-input-address" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Endereço">
                </div>
                <input type="password" id="modal-input-driver-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Senha">
                <input type="password" id="modal-input-admin-password" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none" placeholder="Senha do Admin">
            </div>
            <div id="modal-buttons" class="flex justify-center gap-4">
                 <button id="modal-cancel" onclick="closeModal()" class="py-2 px-6 font-semibold rounded-lg bg-gray-500 hover:bg-gray-600">Cancelar</button>
                 <button id="modal-confirm" class="py-2 px-8 font-semibold rounded-lg button-gradient">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // NOVA CONSTANTE - CHAVE DA API GEOAPIFY
        // ========================================================================
        const GEOAPIFY_API_KEY = '3bd73ecada1d478a8c9473ad4115be38';

        // ========================================================================
        // FUNÇÃO ATUALIZADA - getDrivingDistance
        // ========================================================================
        // Esta função agora converte endereços em coordenadas ANTES de chamar seu backend.
        async function getDrivingDistance(originAddress, destinationAddress) {
            
            // 1. Geocodificar os dois endereços
            let originCoords, destCoords;
            try {
                // Tenta geocodificar a origem
                originCoords = await geocodeAddress(originAddress);
                if (!originCoords) throw new Error('Falha ao geocodificar origem');
                
                // Tenta geocodificar o destino
                destCoords = await geocodeAddress(destinationAddress);
                if (!destCoords) throw new Error('Falha ao geocodificar destino');

            } catch (error) {
                console.error('Erro na geocodificação para cálculo de distância:', error);
                return null; // Retorna nulo se qualquer geocodificação falhar
            }

            // 2. Formatar coordenadas para a API de backend
            const originsString = `${originCoords.lat},${originCoords.lng}`;
            const destinationsString = `${destCoords.lat},${destCoords.lng}`;

            // 3. Chamar a API de backend (get-distance.js) com as coordenadas
            const url = `/api/get-distance?origins=${encodeURIComponent(originsString)}&destinations=${encodeURIComponent(destinationsString)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                // 4. Processar a resposta (esta lógica é a mesma de antes)
                if (data.status === 'OK' && data.rows[0].elements[0].status === 'OK') {
                    const distanceInMeters = data.rows[0].elements[0].distance.value;
                    return distanceInMeters / 1000; // Converte metros para km
                } else {
                    console.error('Erro na API Vercel:', data.status, data.error_message);
                    return null;
                }
            } catch (error) {
                console.error('Erro ao buscar a distância:', error);
                return null;
            }
        }


        // --- FUNÇÕES AUXILIARES IMPORTANTES ---

        // Função para limpar a string de endereço (remove colchetes e aspas)
        function cleanAddressString(address) {
            if (typeof address !== 'string') return '';
            // Remove a formatação específica `["..."]`
            return address.replace(/^\["|"\]$/g, '').trim();
        }

        // ========================================================================
        // NOVA FUNÇÃO AUXILIAR - formatDestination
        // ========================================================================
        function formatDestination(destinationString) {
            if (typeof destinationString !== 'string' || !destinationString.trim()) return '-';

            let formattedAddress = '-';
            const trimmedString = destinationString.trim();

            // Try parsing as complex JSON array [{...}, {...}]
            if (trimmedString.startsWith('[{') && trimmedString.endsWith('}]')) {
                try {
                    const destinationsArray = JSON.parse(trimmedString);
                    if (Array.isArray(destinationsArray)) {
                        const addresses = destinationsArray
                            .map(dest => dest.address || '') // Get address from each object
                            .filter(Boolean); // Remove empty addresses
                        if (addresses.length > 0) {
                            formattedAddress = addresses.join(' - '); // Join with hyphen
                        }
                    }
                } catch (e) {
                    console.warn("Could not parse complex destination JSON, falling back:", trimmedString, e);
                    // Fallback attempt: Try to extract addresses using regex if JSON parse fails
                     const regexAddresses = trimmedString.match(/"address":"(.*?)"/g);
                     if (regexAddresses) {
                         formattedAddress = regexAddresses.map(match => match.replace(/"address":"(.*)"/, '$1')).join(' - ');
                     } else {
                         // Final fallback: just clean the string
                         formattedAddress = trimmedString.replace(/[\[\]\{\}"]/g, '').replace(/name:.*?,address:/g, '').replace(/,/g, ' - ').trim();
                     }
                }
            }
            // Try cleaning as simple format ["address"] or just "address"
            else {
                 formattedAddress = trimmedString.replace(/^\["|"\]$/g, '').trim();
            }

            // Ensure we don't return an empty string
            return formattedAddress || '-';
        }


        // ========================================================================
        // FUNÇÃO ATUALIZADA - geocodeAddress
        // ========================================================================
        // Esta função agora usa a API de Geocoding do Geoapify
        async function geocodeAddress(address) {
            // Se o endereço for nulo ou inválido, rejeita imediatamente
            if (!address || typeof address !== 'string' || address.trim().length < 3) {
                console.warn(`Tentativa de geocodificar endereço inválido: ${address}`);
                return Promise.reject("Endereço inválido");
            }
            
            const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(address)}&filter=countrycode:br&lang=pt&apiKey=${GEOAPIFY_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    const coords = data.features[0].geometry.coordinates;
                    // ATENÇÃO: Geoapify retorna [lng, lat], Google retorna {lat, lng}
                    return { lat: coords[1], lng: coords[0] };
                } else {
                    // Segunda tentativa, adicionando contexto local (Guaíba)
                    const newAddress = `${address}, Guaíba, RS`;
                    const fallbackUrl = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(newAddress)}&filter=countrycode:br&lang=pt&apiKey=${GEOAPIFY_API_KEY}`;
                    
                    const fallbackResponse = await fetch(fallbackUrl);
                    const fallbackData = await fallbackResponse.json();

                    if (fallbackData.features && fallbackData.features.length > 0) {
                        const coords = fallbackData.features[0].geometry.coordinates;
                        return { lat: coords[1], lng: coords[0] };
                    } else {
                        console.error(`A segunda geocodificação também falhou para: ${newAddress}`);
                        throw new Error('ZERO_RESULTS');
                    }
                }
            } catch (error) {
                console.error(`Geocodificação falhou para: ${address}`, error);
                throw error;
            }
        }


        // Calcula a distância em km entre dois pontos geográficos usando a fórmula de Haversine
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em quilômetros
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distância em km
            return d;
        }

        // Converte graus para radianos
        function deg2rad(deg) { 
            return deg * (Math.PI / 180); 
        }

        // --- CONFIGURAÇÃO INICIAL E ESTADO DA APLICAÇÃO ---
        let driverWatchId = null; 
        let map; // Será usado pelo Leaflet
        let heatmap; // Será usado pelo Leaflet.heat
        let tempDriverId = null; // Armazena temporariamente o ID do motorista para login
        let driverChart = null; // Referência para o gráfico de pizza dos motoristas
        let countdownInterval = null;
        let countdownSeconds = 5;
        let clockInterval = null;

        let state = {
            rides: [],
            drivers: [],
            users: [],
            appIcon: localStorage.getItem('appIcon') || null, // Ícone do app salvo no localStorage
            currentDriverId: null,
            currentUserRideId: null,
            currentUserId: null,
            userStatusInterval: null, // Intervalo para checar status da corrida do usuário
            // Armazena os dados de lat/lon do autocomplete
            currentUserOrigin: null, 
            currentUserDestination: null
        };

        // --- CONFIGURAÇÃO DO SUPABASE ---
        const SUPABASE_URL = 'https://jowsbmuqbzxukbbxbeqv.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impvd3NibXVxYnp4dWtiYnhiZXF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzA5NjQsImV4cCI6MjA3MTA0Njk2NH0.UMW2aQmuq0RiEHgody5StKEQzDjrKZnfUprDgDaMd1w';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- LÓGICA DE ÁUDIO (SIRENE) ---
        const adminRingtone = document.getElementById('admin-ringtone');
        let adminRingInterval = null;
        let adminAudioUnlocked = false;

        function unlockAdminAudio() {
            if (adminAudioUnlocked) return;
            if (!adminRingtone) return;
            adminRingtone.muted = true;
            adminRingtone.play().then(() => {
                adminRingtone.pause();
                adminRingtone.currentTime = 0;
                adminRingtone.muted = false;
                adminAudioUnlocked = true;
                console.log("Áudio do Admin desbloqueado.");
                document.body.removeEventListener('click', unlockAdminAudio);
                document.body.removeEventListener('touchstart', unlockAdminAudio);
            }).catch(() => {
                adminRingtone.muted = false;
            });
        }

        document.body.addEventListener('click', unlockAdminAudio);
        document.body.addEventListener('touchstart', unlockAdminAudio);

        function playAdminRingSound() {
            if (!adminAudioUnlocked) {
                console.warn("Áudio do admin bloqueado, aguardando interação do usuário.");
                return;
            }
            adminRingtone.currentTime = 0;
            adminRingtone.play().catch(e => console.error("Erro ao tocar som do admin:", e));
        }

        function startRingingAdmin() {
            stopRingingAdmin(); 
            playAdminRingSound(); 
            adminRingInterval = setInterval(playAdminRingSound, 6000);

            // Adicionado botão de silenciar ao DOM para poder ser usado
            const silenceBtnContainer = document.querySelector('#admin-requests-screen .lg\\:col-span-1');
            if (silenceBtnContainer && !document.getElementById('admin-silence-btn')) {
                const silenceBtn = document.createElement('button');
                silenceBtn.id = 'admin-silence-btn';
                silenceBtn.textContent = 'Silenciar Alerta';
                silenceBtn.className = 'w-full mb-4 py-2 px-4 font-semibold rounded-lg bg-yellow-500 text-gray-900';
                silenceBtn.onclick = stopRingingAdmin;
                silenceBtnContainer.prepend(silenceBtn);
            }
            document.getElementById('admin-silence-btn')?.classList.remove('hidden');
        }

        function stopRingingAdmin() {
            if (adminRingInterval) {
                clearInterval(adminRingInterval);
                adminRingInterval = null;
            }
            if(adminRingtone) {
                adminRingtone.pause();
                adminRingtone.currentTime = 0;
            }
            document.getElementById('admin-silence-btn')?.classList.add('hidden');
        }


        // --- LÓGICA DE MODAL ---
        function showModal(message, onConfirm, showCancel = false, content = {}) {
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            const inputContainer = document.getElementById('modal-input-container');

            Array.from(inputContainer.children).forEach(child => {
                if (child.tagName === 'INPUT' || child.tagName === 'SELECT' || child.classList.contains('autocomplete-container')) {
                    child.style.display = 'none';
                    // Limpa inputs, exceto o container do autocomplete
                    if (child.tagName !== 'DIV') child.value = ''; 
                }
            });

            // Limpa o input de endereço dentro do container do modal
            const modalAddressInput = document.getElementById('modal-input-address');
            if (modalAddressInput) modalAddressInput.value = '';


            if (content.type) {
                inputContainer.classList.remove('hidden');
                if(content.type === 'edit-driver') {
                    document.getElementById('modal-input-name').style.display = 'block';
                    document.getElementById('modal-input-phone').style.display = 'block';
                    document.getElementById('modal-input-plate').style.display = 'block';
                    document.getElementById('modal-input-model').style.display = 'block';
                    document.getElementById('modal-input-color').style.display = 'block';
                    document.getElementById('modal-input-password').style.display = 'block'; 
                    document.getElementById('modal-input-status').style.display = 'block';
                    document.getElementById('modal-input-name').value = content.name;
                    document.getElementById('modal-input-phone').value = content.phone;
                    document.getElementById('modal-input-plate').value = content.plate;
                    document.getElementById('modal-input-model').value = content.car_model || '';
                    document.getElementById('modal-input-color').value = content.car_color || '';
                    document.getElementById('modal-input-status').value = content.status;
                } else if (content.type === 'edit-user') {
                    document.getElementById('modal-input-matricula').style.display = 'block';
                    document.getElementById('modal-input-name').style.display = 'block';
                    document.getElementById('modal-input-password').style.display = 'block'; 
                    document.getElementById('modal-input-company').style.display = 'block';
                    document.getElementById('modal-input-address').parentElement.style.display = 'block'; // Mostra o container do autocomplete
                    document.getElementById('modal-input-phone').style.display = 'block';
                    
                    document.getElementById('modal-input-matricula').value = content.matricula;
                    document.getElementById('modal-input-name').value = content.name;
                    document.getElementById('modal-input-company').value = content.company;
                    document.getElementById('modal-input-address').value = content.address; // Define o valor do input de endereço
                    document.getElementById('modal-input-phone').value = content.phone;
                    
                    // Inicializa o autocomplete para o modal
                    initAutocomplete(document.getElementById('modal-input-address'));

                } else if(content.type === 'driver-password') {
                    document.getElementById('modal-input-driver-password').style.display = 'block';
                } else if(content.type === 'delete-with-password') {
                    document.getElementById('modal-input-admin-password').style.display = 'block';
                }
            } else {
                 inputContainer.classList.add('hidden'); 
            }

            confirmBtn.onclick = onConfirm;
            cancelBtn.style.display = showCancel ? 'inline-block' : 'none';
            confirmBtn.textContent = showCancel ? 'Confirmar' : 'OK';
            if (!showCancel) {
                confirmBtn.onclick = closeModal;
            }

            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex'); 
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            Array.from(document.getElementById('modal-input-container').children).forEach(child => {
                 if (child.tagName === 'INPUT' || child.tagName === 'SELECT') {
                    child.value = '';
                    child.style.display = 'none'; 
                }
                 if (child.classList.contains('autocomplete-container')) {
                     child.style.display = 'none';
                     // Remove a instância do autocomplete para evitar duplicatas
                     const input = child.querySelector('input');
                     if (input && input.geoapify_autocomplete_instance) {
                         input.geoapify_autocomplete_instance.destroy();
                         input.geoapify_autocomplete_instance = null;
                     }
                 }
            });
        }

        // --- FUNÇÕES DE LOGIN E SESSÃO ---
        function logout() {
            state.currentUserId = null;
            state.currentDriverId = null;
            localStorage.removeItem('sessionType');
            localStorage.removeItem('loggedInUserId');
            localStorage.removeItem('loggedInDriverId');
            showScreen('initial-screen');
        }

        async function loginAdmin() { 
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            if (password === '789512') { 
                errorEl.classList.add('hidden');
                document.getElementById('admin-password').value = ''; 
                localStorage.setItem('sessionType', 'admin');
                showScreen('admin-screen'); 
            } else {
                errorEl.classList.remove('hidden'); 
            }
        }

        async function loginUser() {
            const matricula = document.getElementById('user-id').value;
            const password = document.getElementById('user-password').value;
            const errorEl = document.getElementById('user-login-error');

            const { data: user, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('matricula', matricula)
                .eq('password', password)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error('Erro no Supabase ao tentar login:', error);
                errorEl.textContent = 'Erro de comunicação com o servidor. Por favor, tente novamente.';
                errorEl.classList.remove('hidden');
                return; 
            }

            if (user) {
                state.currentUserId = user.id;
                localStorage.setItem('sessionType', 'user');
                localStorage.setItem('loggedInUserId', user.id);
                errorEl.classList.add('hidden');
                document.getElementById('user-id').value = ''; 
                document.getElementById('user-password').value = '';
                showScreen('user-screen'); 
            } else {
                errorEl.textContent = 'Matrícula ou senha incorreta!';
                errorEl.classList.remove('hidden');
            }
        }

        // --- NAVEGAÇÃO ENTRE TELAS ---
        function showScreen(screenId) {
            const body = document.body;
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            stopRingingAdmin(); // Para a sirene do admin ao trocar de tela

            if(clockInterval) clearInterval(clockInterval);

            // Aplica ou remove padding extra no topo para telas específicas
            const container = document.getElementById('app-container');
            const needsExtraPadding = ['admin-requests-screen', 'admin-driver-crud-screen', 'admin-user-crud-screen', 'admin-heatmap-screen', 'admin-records-screen'];
             if (needsExtraPadding.includes(screenId)) {
                container.classList.add('pt-8'); // Adiciona padding top
            } else {
                 container.classList.remove('pt-8'); // Remove padding top
            }


            const fullHeightScreens = ['admin-requests-screen', 'admin-driver-crud-screen', 'admin-user-crud-screen', 'admin-heatmap-screen', 'admin-records-screen'];
            if (fullHeightScreens.includes(screenId)) {
                body.classList.remove('items-center');
                body.classList.add('justify-start'); // Alinha conteúdo ao topo
            } else {
                if (!body.classList.contains('items-center')) {
                    body.classList.add('items-center');
                }
                 body.classList.remove('justify-start'); // Remove alinhamento ao topo
            }

            if (screenId === 'admin-requests-screen') {
                loadAdminRequests();
                renderOngoingRidesTable();
                startDigitalClock('digital-clock');
            }
            if (screenId === 'admin-driver-crud-screen') renderDriverCrudList();
            if (screenId === 'admin-user-crud-screen') {
                 renderUserCrudList();
                 // Inicializa o autocomplete para o formulário "Adicionar Novo Usuário"
                 initAutocomplete(document.getElementById('new-user-address'));
            }
            if (screenId === 'admin-heatmap-screen') initHeatmap();
            if (screenId === 'driver-selection-screen') populateDriverSelection();
            if (screenId === 'driver-screen') {
                loadDriverJobs(); 
                renderDriverRideHistory(); 
            }
            if (screenId === 'user-screen') {
                checkUserRideStatus(); 
                updateAvailableDriversCount(); 
                renderUserRideHistory(); 
                // Inicializa o autocomplete para os inputs de origem e destino do usuário
                initAutocomplete(document.getElementById('origin'), (feature) => {
                    state.currentUserOrigin = feature; // Salva os dados do local
                });
                initAutocomplete(document.getElementById('destination'), (feature) => {
                    state.currentUserDestination = feature; // Salva os dados do local
                });
            }
            if (screenId === 'admin-records-screen') {
                loadAllRecords(); 
                document.getElementById('records-start-date').value = '';
                document.getElementById('records-end-date').value = '';
                 document.getElementById('records-company-filter').value = ''; // Limpa filtro empresa ao entrar
            }
        }

        function startDigitalClock(elementId) {
            const clockElement = document.getElementById(elementId);
            if (!clockElement) return;

            if (clockInterval) clearInterval(clockInterval);

            clockInterval = setInterval(() => {
                const now = new Date();
                clockElement.textContent = now.toLocaleTimeString('pt-BR');
            }, 1000);
        }

        function promptToGoBack() {
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            cancelBtn.textContent = 'Apenas Voltar';
            cancelBtn.onclick = () => {
                closeModal();
                showScreen('admin-screen');
            };

            confirmBtn.textContent = 'Exportar e Voltar';
            confirmBtn.onclick = () => {
                // Verificamos se há corridas ANTES de tentar exportar
                if (state.rides.length === 0) {
                    showModal("Nenhuma corrida para exportar. Voltando ao painel...");
                    // Aguarda 2 segundos para o usuário ler e depois volta
                    setTimeout(() => {
                        closeModal();
                        showScreen('admin-screen');
                    }, 2000);
                } else {
                    // Se houver dados, exporta e volta imediatamente
                    exportDailyReportNow();
                    closeModal();
                    showScreen('admin-screen');
                }
            };

            showModal('Deseja exportar o relatório diário antes de sair?', null, true);
        }

        // --- LÓGICA DO USUÁRIO ---

        async function requestRide() {
            const originAddress = document.getElementById('origin').value;
            const destinationAddress = document.getElementById('destination').value;
            
            // Valida se os dados de autocomplete foram salvos
            if (!state.currentUserOrigin || state.currentUserOrigin.properties.formatted !== originAddress) {
                showModal('Por favor, selecione um endereço de ORIGEM válido da lista de sugestões.');
                return;
            }
             if (!state.currentUserDestination || state.currentUserDestination.properties.formatted !== destinationAddress) {
                showModal('Por favor, selecione um endereço de DESTINO válido da lista de sugestões.');
                return;
            }

            const isScheduled = document.getElementById('schedule-toggle').checked;
            const scheduledTimeValue = document.getElementById('schedule-datetime').value;
            let scheduledTime = null;

            if (isScheduled) {
                if (!scheduledTimeValue) {
                    showModal('Por favor, selecione a data e hora para o agendamento.');
                    return;
                }
                scheduledTime = new Date(scheduledTimeValue).toISOString();
                if (new Date(scheduledTime) < new Date()) {
                    showModal('A data de agendamento não pode ser no passado.');
                    return;
                }
            }

            document.getElementById('user-request-form').classList.add('hidden');
            document.getElementById('user-status').classList.remove('hidden');
            document.getElementById('user-status-message').textContent = 'Solicitando corrida...';

            try {
                // Usa as coordenadas salvas do autocomplete
                const originCoords = state.currentUserOrigin.properties;
                const userLocation = { lat: originCoords.lat, lon: originCoords.lon };
                const currentUser = state.users.find(u => u.id === state.currentUserId);

                const newRide = {
                    destination: destinationAddress, // Salva o endereço de destino como texto
                    origin_address: originAddress,   // Salva o endereço de origem como texto
                    status: 'requested',
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userCompany: currentUser.company,
                    requestTime: new Date().toISOString(),
                    // Salva a localização de origem (Geoapify retorna lon, lat)
                    userLocation: { lat: originCoords.lat, lon: originCoords.lon },
                    request_type: isScheduled ? 'scheduled' : 'immediate', 
                    scheduled_datetime: scheduledTime 
                };

                const { data, error } = await supabaseClient.from('rides').insert([newRide]).select().single();

                if (error) {
                    console.error("Erro ao solicitar corrida:", error);
                    showModal("Não foi possível solicitar a corrida. Verifique os endereços.");
                    document.getElementById('user-request-form').classList.remove('hidden');
                    document.getElementById('user-status').classList.add('hidden');
                    return;
                }

                state.currentUserRideId = data.id;
                document.getElementById('user-status-message').textContent = 'Aguardando um motorista aceitar...';
                startUserStatusCheck();
                
                // Limpa os estados de localização após o sucesso
                state.currentUserOrigin = null;
                state.currentUserDestination = null;

            } catch (error) {
                console.error("Erro ao processar solicitação de corrida:", error);
                showModal('Não foi possível processar sua solicitação.');
                document.getElementById('user-request-form').classList.remove('hidden');
                document.getElementById('user-status').classList.add('hidden');
            }
        }


        function checkUserRideStatus() {
             if (state.currentUserRideId) {
                const myRide = state.rides.find(r => r.id === state.currentUserRideId);
                if (myRide) {
                    document.getElementById('user-request-form').classList.add('hidden');
                    document.getElementById('user-status').classList.remove('hidden');
                    updateUserStatusMessage(myRide); 
                    startUserStatusCheck(); 
                } else {
                    state.currentUserRideId = null; 
                    document.getElementById('user-request-form').classList.remove('hidden');
                    document.getElementById('user-status').classList.add('hidden');
                    document.getElementById('user-status-message').textContent = 'Sua viagem foi finalizada ou cancelada.';
                }
            }
        }

        function startUserStatusCheck() {
            if (state.userStatusInterval) clearInterval(state.userStatusInterval);
            state.userStatusInterval = setInterval(async () => {
                if (!state.currentUserRideId) { 
                    clearInterval(state.userStatusInterval);
                    return;
                }
                const { data: myRide, error } = await supabaseClient.from('rides').select('*').eq('id', state.currentUserRideId).single();
                if (myRide) {
                   updateUserStatusMessage(myRide); 
                } else {
                    clearInterval(state.userStatusInterval);
                    state.currentUserRideId = null; 
                    document.getElementById('user-request-form').classList.remove('hidden');
                    document.getElementById('user-status').classList.add('hidden');
                    document.getElementById('user-status-message').textContent = 'Sua viagem foi finalizada ou cancelada (pelo sistema).';
                }
            }, 5000);
        }

        function updateUserStatusMessage(ride) {
            const searchingIconContainer = document.getElementById('status-icon-searching');
            const enRouteIconContainer = document.getElementById('status-icon-en-route');
            const arrivedPickupIconContainer = document.getElementById('status-icon-arrived-pickup');
            const inProgressIconContainer = document.getElementById('status-icon-in-progress');

            const cancelRideBtn = document.getElementById('cancel-ride-btn');
            let message = 'Aguardando um motorista...';

            searchingIconContainer.classList.add('hidden');
            enRouteIconContainer.classList.add('hidden');
            arrivedPickupIconContainer.classList.add('hidden');
            inProgressIconContainer.classList.add('hidden');
            enRouteIconContainer.innerHTML = ''; 
            arrivedPickupIconContainer.innerHTML = '';
            inProgressIconContainer.innerHTML = '';

            if (ride.status === 'requested' || ride.status === 'assigned' || ride.status === 'accepted' || ride.status === 'arrived_pickup') {
                cancelRideBtn.classList.remove('hidden');
            } else {
                cancelRideBtn.classList.add('hidden');
            }

            switch(ride.status) {
                case 'assigned':
                    message = `Motorista ${ride.driverName} foi designado. Aguardando aceite...`;
                    searchingIconContainer.classList.remove('hidden'); 
                    break;
                case 'accepted':
                    message = `Motorista ${ride.driverName} está a caminho!`;
                    if (ride.driverCurrentLocation && ride.userLocation) {
                        const distance = getDistanceFromLatLonInKm(
                            ride.userLocation.lat, ride.userLocation.lon,
                            ride.driverCurrentLocation.lat, ride.driverCurrentLocation.lon
                        );
                        message += ` Distância: ${distance.toFixed(2)} km`;
                    }
                    const acceptedImg = document.createElement('img');
                    acceptedImg.src = 'images/aceitou.png'; 
                    acceptedImg.alt = 'Motorista Aceitou';
                    acceptedImg.className = 'h-20 w-20 mx-auto'; 
                    enRouteIconContainer.appendChild(acceptedImg);
                    enRouteIconContainer.classList.remove('hidden');
                    break;
                case 'arrived_pickup':
                    message = `Seu motorista, ${ride.driverName}, chegou no local de embarque.`;
                    const arrivedImg = document.createElement('img');
                    arrivedImg.src = 'images/final.png'; 
                    arrivedImg.alt = 'Motorista Chegou';
                    arrivedImg.className = 'h-20 w-20 mx-auto';
                    arrivedPickupIconContainer.appendChild(arrivedImg);
                    arrivedPickupIconContainer.classList.remove('hidden');
                    break;
                case 'in_progress':
                     message = `Viagem para ${formatDestination(ride.destination)} em andamento.`; // Usa destino formatado
                     const inProgressImg = document.createElement('img');
                     inProgressImg.src = 'images/destino.png'; 
                     inProgressImg.alt = 'Viagem Iniciada';
                     inProgressImg.className = 'h-20 w-20 mx-auto animate-bounce'; 
                     inProgressIconContainer.appendChild(inProgressImg);
                     inProgressIconContainer.classList.remove('hidden');
                     cancelRideBtn.classList.add('hidden');
                     break;
                 case 'completed':
                    message = `Viagem finalizada! Obrigado por escolher a GARCIA TAXI.`;
                    clearInterval(state.userStatusInterval); 
                    state.currentUserRideId = null; 
                    setTimeout(() => {
                        document.getElementById('user-request-form').classList.remove('hidden');
                        document.getElementById('user-status').classList.add('hidden');
                        document.getElementById('destination').value = ''; 
                        renderUserRideHistory();
                    }, 5000);
                    break;
                case 'canceled':
                    message = `Sua viagem foi cancelada.`;
                    clearInterval(state.userStatusInterval); 
                    state.currentUserRideId = null; 
                     setTimeout(() => {
                        document.getElementById('user-request-form').classList.remove('hidden');
                        document.getElementById('user-status').classList.add('hidden');
                        document.getElementById('destination').value = ''; 
                        renderUserRideHistory();
                    }, 3000); 
                    break;
            }
            document.getElementById('user-status-message').textContent = message;
        }

        async function cancelRide() {
            if (state.currentUserRideId) {
                if (driverWatchId) {
                    navigator.geolocation.clearWatch(driverWatchId);
                    driverWatchId = null;
                }
                const { error } = await supabaseClient.from('rides').update({ status: 'canceled' }).eq('id', state.currentUserRideId);
                if (error) {
                    showModal('Não foi possível cancelar a corrida.');
                }
            }
        }

        // --- LÓGICA DO ADMIN ---
        // ========================================================================
        // FUNÇÃO CORRIGIDA (loadAdminRequests)
        // ========================================================================
        async function loadAdminRequests() {
            const list = document.getElementById('admin-requests-list');
            list.innerHTML = '';

            const requestedRides = state.rides.filter(r => r.status === 'requested' || r.status === 'approved' || r.status === 'pending_approval' || r.status === 'scheduled');

            requestedRides.sort((a, b) => new Date((a.request_type === 'scheduled' && a.scheduled_datetime) || a.requestTime) - new Date((b.request_type === 'scheduled' && b.scheduled_datetime) || b.requestTime));

            // --- Cálculos para o painel de status ---
            const solicitadoCount = state.rides.filter(r => ['requested', 'approved', 'pending_approval'].includes(r.status)).length;
            const agendadaCount = state.rides.filter(r => r.status === 'scheduled').length;
            const designadoCount = state.rides.filter(r => r.status === 'assigned').length;
            const emAndamentoCount = state.rides.filter(r => ['accepted', 'arrived_pickup', 'in_progress'].includes(r.status)).length;
            const concluidasCount = state.rides.filter(r => r.status === 'completed').length;

            // --- Atualiza os contadores no painel ---
            document.getElementById('status-agendada-count').textContent = agendadaCount;
            document.getElementById('status-solicitado-count').textContent = solicitadoCount;
            document.getElementById('status-designado-count').textContent = designadoCount;
            document.getElementById('status-em-andamento-count').textContent = emAndamentoCount;
            document.getElementById('status-concluidas-count').textContent = concluidasCount;

            const activeDriversCount = state.drivers.filter(d => d.status === 'active').length;
            const totalDriversCount = state.drivers.length;

            document.getElementById('total-drivers-count').textContent = totalDriversCount;
            document.getElementById('active-drivers-count').textContent = activeDriversCount;
            document.getElementById('inactive-drivers-count').textContent = totalDriversCount - activeDriversCount;

            renderDriverStatusChart(activeDriversCount, totalDriversCount - activeDriversCount);

            if (requestedRides.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400">Nenhuma nova solicitação.</p>';
            } else {
                for (const ride of requestedRides) {
                    const card = document.createElement('div');
                    card.className = 'card-gradient p-4 rounded-lg shadow-md';

                    const originAddress = cleanAddressString(ride.origin_address);
                    // Usa a nova função para formatar o destino
                    const destinationAddress = formatDestination(ride.destination);
                    let distanceInfo = `<p class="text-sm text-gray-500">Distância: Calculando...</p>`;

                    // Usa os endereços brutos para calcular a distância
                    if (ride.origin_address && ride.destination) {
                         const distance = await getDrivingDistance(ride.origin_address, ride.destination);
                         if (distance !== null) {
                            distanceInfo = `<p class="font-semibold">Distância: <span class="font-normal">${distance.toFixed(1)} km</span></p>`;
                         } else {
                            distanceInfo = `<p class="text-sm text-red-400">Distância: Erro ao calcular</p>`;
                         }
                    }

                    let rideTypeInfo = '';
                    if (ride.request_type === 'scheduled' && ride.scheduled_datetime) {
                        const scheduledDate = new Date(ride.scheduled_datetime);
                        const formattedTime = scheduledDate.toLocaleString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        rideTypeInfo = `<span class="text-xs font-bold py-1 px-2 rounded-full bg-orange-500 text-white">AGENDADA ${formattedTime}</span>`;
                    } else {
                        rideTypeInfo = '<span class="text-xs font-bold py-1 px-2 rounded-full bg-blue-500 text-white">IMEDIATA</span>';
                    }

                    let actionContent = '';
                    if (ride.status === 'pending_approval') {
                        actionContent = `
                            <div class="mt-4 text-center p-2 rounded-lg bg-yellow-700 text-white font-semibold">
                                Aguardando Aprovação
                            </div>
                        `;
                    } else {
                        const activeDrivers = state.drivers.filter(d => d.status === 'active');
                        let driverOptions = activeDrivers.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                        if (activeDrivers.length === 0) {
                            driverOptions = `<option value="" disabled>Nenhum motorista ativo</option>`;
                        }
                        actionContent = `
                            <div class="mt-4 flex gap-2">
                                <select id="driver-select-${ride.id}" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-white">
                                    <option value="" class="text-gray-400">Selecione um motorista</option>
                                    ${driverOptions}
                                </select>
                                <button onclick="assignDriver(${ride.id})" class="py-2 px-4 font-semibold rounded-lg button-gradient whitespace-nowrap text-white">Marcar</button>
                            </div>
                        `;
                    }

                    // CORREÇÃO: Comentário removido daqui
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-lg">Nova Solicitação</h4>
                            ${rideTypeInfo}
                        </div>
                        <p class="font-semibold">Origem: <span class="font-normal">${originAddress || 'Não informado'}</span></p>
                        <p class="font-semibold">Destino: <span class="font-normal">${destinationAddress}</span></p> 
                        <p class="font-semibold">Observação: <span class="font-normal text-yellow-300">${ride.observation || 'Nenhuma'}</span></p>
                        ${distanceInfo}
                        <p class="text-sm text-gray-400">De: ${ride.userName} ${ride.userCompany ? `(${ride.userCompany})` : ''}</p>
                        <p class="text-sm text-gray-300">Solicitado em: ${new Date(ride.requestTime).toLocaleTimeString()}</p>
                        ${actionContent}
                    `;

                    list.appendChild(card);
                };
            }
        }
        
        // ========================================================================
        // FUNÇÃO CORRIGIDA (renderOngoingRidesTable)
        // ========================================================================
        async function renderOngoingRidesTable() {
            const tableContainer = document.getElementById('admin-ongoing-rides-table');
            tableContainer.innerHTML = '<div class="loader mx-auto"></div>';

            const ongoingRides = state.rides.filter(r => !['requested', 'approved', 'pending_approval', 'rejected', 'completed', 'canceled'].includes(r.status));

            if (ongoingRides.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-400">Nenhuma corrida em andamento no momento.</p>';
                return;
            }

            const ridesWithDistancePromises = ongoingRides.map(async (ride) => {
                let distanceKm = 'N/D';
                const originAddress = cleanAddressString(ride.origin_address);
                 // Formata o destino usando a nova função
                const formattedDestination = formatDestination(ride.destination); 

                // Usa os endereços brutos para calcular a distância
                if (ride.origin_address && ride.destination) {
                    const distance = await getDrivingDistance(ride.origin_address, ride.destination); 
                    if (distance !== null) {
                        distanceKm = distance.toFixed(1);
                    } else {
                        distanceKm = 'Erro';
                    }
                }
                // Retorna o destino formatado
                return { ...ride, distanceKm, cleanedOrigin: originAddress, formattedDestination: formattedDestination }; 
            });

            const ridesWithDistance = await Promise.all(ridesWithDistancePromises);

            let tableHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
                        <tr>
                            <th scope="col" class="px-4 py-3">Usuário</th>
                            <th scope="col" class="px-4 py-3">Origem</th>
                            <th scope="col" class="px-4 py-3">Destino</th>
                            <th scope="col" class="px-4 py-3">Observação</th>
                            <th scope="col" class="px-4 py-3">Distância (km)</th>
                            <th scope="col" class="px-4 py-3">Motorista</th>
                            <th scope="col" class="px-4 py-3">Status</th>
                            <th scope="col" class="px-4 py-3">Tipo</th>
                            <th scope="col" class="px-4 py-3">Data/Hora</th>
                            <th scope="col" class="px-4 py-3">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Ordena primeiro por data/hora (agendada ou solicitação)
            ridesWithDistance.sort((a, b) => {
                const dateA = (a.request_type === 'scheduled' && a.scheduled_datetime) ? new Date(a.scheduled_datetime) : new Date(a.requestTime);
                const dateB = (b.request_type === 'scheduled' && b.scheduled_datetime) ? new Date(b.scheduled_datetime) : new Date(b.requestTime);
                return dateA - dateB;
            });

            ridesWithDistance.forEach(ride => {
                const statusInfo = translateStatus(ride.status); 

                let rideTypeInfo = '';
                if (ride.request_type === 'scheduled') {
                    rideTypeInfo = `<span class="text-xs font-bold py-1 px-2 rounded-full bg-orange-500 text-white">AGENDADA</span>`;
                } else {
                    rideTypeInfo = '<span class="text-xs font-bold py-1 px-2 rounded-full bg-blue-500 text-white">IMEDIATA</span>';
                }

                // --- LÓGICA DA DATA/HORA ---
                let dateTimeString = '';
                const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                if (ride.request_type === 'scheduled' && ride.scheduled_datetime) {
                    dateTimeString = new Date(ride.scheduled_datetime).toLocaleString('pt-BR', options);
                } else { 
                    dateTimeString = new Date(ride.requestTime).toLocaleString('pt-BR', options);
                }
                // --- FIM DA LÓGICA DA DATA/HORA ---

                let driverCellHTML = ride.driverName || 'N/A';
                let actionsCellHTML = `<div class="flex items-center gap-2">`;

                if (ride.status !== 'in_progress' && ride.status !== 'arrived_pickup') {
                    const activeDrivers = state.drivers.filter(d => d.status === 'active');
                    let driverOptions = activeDrivers.map(d => `<option value="${d.id}" ${ride.driverId == d.id ? 'selected' : ''}>${d.name}</option>`).join('');

                    driverCellHTML = `
                        <select id="ongoing-driver-select-${ride.id}" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none text-xs text-white">
                            <option value="" class="text-gray-400">Selecione...</option>
                            ${driverOptions}
                        </select>
                    `;

                    actionsCellHTML += `<button onclick="updateRideDriver(${ride.id})" class="py-1 px-2 text-xs font-semibold rounded-lg button-gradient whitespace-nowrap text-white">Salvar</button>`;
                }

                actionsCellHTML += `
                    <button onclick="adminCompleteRide(${ride.id})" title="Marcar como Finalizada" class="p-1 rounded-lg bg-green-600 hover:bg-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </button>
                    <button onclick="adminDeleteRide(${ride.id})" title="Excluir Corrida" class="p-1 rounded-lg bg-red-600 hover:bg-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>`;

                // CORREÇÃO: Comentários removidos daqui também
                tableHTML += `
                    <tr class="border-b border-gray-700 hover:bg-gray-800/20">
                        <td class="px-4 py-3 font-medium">${ride.userName}</td>
                        <td class="px-4 py-3">${ride.cleanedOrigin || '-'}</td> 
                        <td class="px-4 py-3">${ride.formattedDestination}</td> 
                        <td class="px-4 py-3 text-yellow-300">${ride.observation || '-'}</td>
                        <td class="px-4 py-3 font-semibold">${ride.distanceKm}</td>
                        <td class="px-4 py-3">${driverCellHTML}</td>
                        <td class="px-4 py-3">
                            <span class="status-badge ${statusInfo.colorClass}">${statusInfo.text}</span>
                        </td>
                        <td class="px-4 py-3">${rideTypeInfo}</td>
                        <td class="px-4 py-3">${dateTimeString}</td> 
                        <td class="px-4 py-3">${actionsCellHTML}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
        }


        async function updateRideDriver(rideId) {
            const selectElement = document.getElementById(`ongoing-driver-select-${rideId}`);
            if (!selectElement) return;

            const selectedDriverId = selectElement.value;

            if (!selectedDriverId) {
                showModal("Por favor, selecione um motorista para salvar.");
                return;
            }

            const driver = state.drivers.find(d => d.id == selectedDriverId);
            if (!driver) {
                showModal("Motorista selecionado não encontrado.");
                return;
            }

            const { error } = await supabaseClient
                .from('rides')
                .update({ 
                    status: 'assigned', 
                    driverId: parseInt(driver.id), 
                    driverName: driver.name 
                })
                .eq('id', rideId);

            if (error) {
                console.error("Erro ao atualizar motorista da corrida:", error);
                showModal("Não foi possível atualizar o motorista.");
            } else {
                showModal("Motorista atribuído com sucesso!");
            }
        }


        async function assignDriver(rideId) {
            const selectedDriverId = document.getElementById(`driver-select-${rideId}`).value;
            if (!selectedDriverId) {
                showModal('Por favor, selecione um motorista.');
                return;
            }
            const driver = state.drivers.find(d => d.id == selectedDriverId);
            const { error } = await supabaseClient.from('rides').update({ status: 'assigned', driverId: parseInt(driver.id), driverName: driver.name }).eq('id', rideId);
            if (error) { 
                console.error("Erro ao designar motorista:", error);
                showModal("Não foi possível designar o motorista.");
            }
        }

        // --- ADMIN CRUD MOTORISTAS ---
        function renderDriverCrudList() {
            const listContainer = document.getElementById('driver-crud-list');
            listContainer.innerHTML = '';
            if (state.drivers.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum motorista cadastrado.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            table.innerHTML = `
                <thead class="text-xs text-gray-300 uppercase bg-gray-900/30 sticky top-0">
                    <tr>
                        <th scope="col" class="px-4 py-3">Motorista</th>
                        <th scope="col" class="px-4 py-3">Placa</th>
                        <th scope="col" class="px-4 py-3 text-right">Ações</th>
                    </tr>
                </thead>`;
            const tbody = document.createElement('tbody');
            state.drivers.forEach(driver => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-800/20';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">
                        <div class="flex items-center gap-3">
                           <label class="toggle-switch">
                                <input type="checkbox" onchange="toggleDriverStatusAdmin(${driver.id})" ${driver.status === 'active' ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                            <div>
                                <div>${driver.name}</div>
                                <div class="text-xs text-gray-400">${driver.phone}</div>
                                <div class="text-xs text-gray-500">${driver.car_model || ''} - ${driver.car_color || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">${driver.plate}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editDriver(${driver.id})" class="font-medium text-yellow-400 hover:underline mr-3">Editar</button>
                        <button onclick="promptDeleteDriver(${driver.id})" class="font-medium text-red-500 hover:underline">Excluir</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            listContainer.appendChild(table);
        }

        async function addDriver() {
            const nameInput = document.getElementById('new-driver-name');
            const phoneInput = document.getElementById('new-driver-phone');
            const plateInput = document.getElementById('new-driver-plate');
            const modelInput = document.getElementById('new-driver-model');
            const colorInput = document.getElementById('new-driver-color');
            const passwordInput = document.getElementById('new-driver-password');

            const name = nameInput.value.trim(); 
            const phone = phoneInput.value.trim();
            const plate = plateInput.value.trim();
            const model = modelInput.value.trim();
            const color = colorInput.value.trim();
            const password = passwordInput.value.trim();

            if (!name || !phone || !plate || !password || !model || !color) { 
                showModal('Todos os campos são obrigatórios.'); 
                return; 
            }
            const { error } = await supabaseClient.from('drivers').insert([{ 
                name, phone, plate, password, status: 'inactive', car_model: model, car_color: color 
            }]);

            if (error) { 
                console.error('Error adding driver:', error); 
                showModal('Erro ao adicionar motorista.'); 
            } else { 
                nameInput.value = phoneInput.value = plateInput.value = passwordInput.value = modelInput.value = colorInput.value = ''; 
                showModal('Motorista adicionado com sucesso!'); 
            }
        }

        function editDriver(driverId) {
            const driver = state.drivers.find(d => d.id === driverId);
            if (!driver) return;
            const onConfirm = async () => {
                const newName = document.getElementById('modal-input-name').value.trim();
                const newPhone = document.getElementById('modal-input-phone').value.trim();
                const newPlate = document.getElementById('modal-input-plate').value.trim();
                const newModel = document.getElementById('modal-input-model').value.trim();
                const newColor = document.getElementById('modal-input-color').value.trim();
                const newPassword = document.getElementById('modal-input-password').value.trim();
                const newStatus = document.getElementById('modal-input-status').value;

                if (newName && newPhone && newPlate && newModel && newColor) {
                    const updateData = { 
                        name: newName, 
                        phone: newPhone, 
                        plate: newPlate, 
                        status: newStatus,
                        car_model: newModel,
                        car_color: newColor
                    };
                    if (newPassword) updateData.password = newPassword;
                    const { error } = await supabaseClient.from('drivers').update(updateData).eq('id', driverId);
                    if (error) { 
                        console.error('Error updating driver:', error); 
                        showModal('Erro ao atualizar motorista.'); 
                    } else { 
                        closeModal(); 
                    }
                } else { 
                    showModal('Nome, Telefone, Placa, Modelo e Cor são obrigatórios.'); 
                }
            };
            showModal('Editar dados do motorista:', onConfirm, true, { 
                type: 'edit-driver', 
                name: driver.name, 
                phone: driver.phone, 
                plate: driver.plate, 
                car_model: driver.car_model,
                car_color: driver.car_color,
                status: driver.status 
            });
        }

        function promptDeleteDriver(driverId) {
            const onConfirm = async () => {
                const password = document.getElementById('modal-input-admin-password').value;
                if (password === '789512') { deleteDriver(driverId); } 
                else { showModal('Senha incorreta!'); }
            };
            showModal('Digite a senha do admin para excluir:', onConfirm, true, { type: 'delete-with-password' });
        }

        async function deleteDriver(driverId) {
            const { error } = await supabaseClient.from('drivers').delete().eq('id', driverId);
            if (error) { console.error('Error deleting driver:', error); showModal('Erro ao excluir motorista.'); } 
            else { closeModal(); }
        }

        // --- ADMIN CRUD USUÁRIOS ---
        function downloadUserTemplate() {
            const headers = [["matricula", "nome", "senha", "empresa", "endereco", "telefone"]];
            const ws = XLSX.utils.aoa_to_sheet(headers);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Usuarios");
            XLSX.writeFile(wb, "template_usuarios.xlsx");
        }

        function importUsersFromExcel() {
            const fileInput = document.getElementById('excel-file-input');
            const file = fileInput.files[0];
            if (!file) { showModal("Por favor, selecione um arquivo Excel."); return; }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const usersJson = XLSX.utils.sheet_to_json(worksheet);

                    if (usersJson.length === 0) { showModal("O arquivo Excel está vazio."); return; }

                    const header = Object.keys(usersJson[0]);
                    const expectedHeader = ['matricula', 'nome', 'senha', 'empresa', 'endereco', 'telefone'];
                    if (JSON.stringify(header.sort()) !== JSON.stringify(expectedHeader.sort())) {
                        showModal(`Cabeçalho inválido. O esperado é: ${expectedHeader.join(',')}`);
                        return;
                    }

                    let importedCount = 0;
                    usersJson.forEach(user => {
                        if (user.matricula && user.nome && user.senha && user.telefone) {
                            state.users.push({
                                id: `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, 
                                matricula: String(user.matricula).trim(),
                                name: String(user.nome).trim(),
                                password: String(user.senha).trim(),
                                company: String(user.empresa || '').trim(),
                                address: String(user.endereco || '').trim(),
                                phone: String(user.phone || '').trim()
                            });
                            importedCount++;
                        }
                    });

                    if (importedCount > 0) {
                        renderUserCrudList();
                        showModal(`${importedCount} usuários foram importados com sucesso!`);
                    } else {
                        showModal("Nenhum usuário válido encontrado no arquivo para importar.");
                    }
                    fileInput.value = '';
                } catch (error) {
                    showModal("Ocorreu um erro ao processar o arquivo. Verifique se o formato está correto.");
                }
            };
            reader.onerror = function() { showModal("Ocorreu um erro ao ler o arquivo."); };
            reader.readAsArrayBuffer(file);
        }

        function renderUserCrudList() {
            const listContainer = document.getElementById('user-crud-list');
            listContainer.innerHTML = ''; 

            const userCountEl = document.getElementById('user-count');
            if (userCountEl) {
                userCountEl.textContent = state.users.length;
            }

            if (state.users.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum usuário cadastrado.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            table.innerHTML = `
                <thead class="text-xs text-gray-300 uppercase bg-gray-900/30 sticky top-0">
                    <tr>
                        <th scope="col" class="px-4 py-3">Nome</th>
                        <th scope="col" class="px-4 py-3">Telefone</th>
                        <th scope="col" class="px-4 py-3 text-right">Ações</th>
                    </tr>
                </thead>`;
            const tbody = document.createElement('tbody');
            state.users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-800/20';
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">
                        <div>${user.name}</div>
                        <div class="text-xs text-gray-400">${user.company || ''}</div>
                    </td>
                    <td class="px-4 py-3">${user.phone}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editUser(${user.id})" class="font-medium text-yellow-400 hover:underline mr-3">Editar</button>
                        <button onclick="deleteUser(${user.id})" class="font-medium text-red-500 hover:underline">Excluir</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            listContainer.appendChild(table);
        }

        async function addUser() {
            const idInput = document.getElementById('new-user-id'); const nameInput = document.getElementById('new-user-name');
            const passwordInput = document.getElementById('new-user-password'); const companyInput = document.getElementById('new-user-company');
            const addressInput = document.getElementById('new-user-address'); const phoneInput = document.getElementById('new-user-phone');
            const matricula = idInput.value.trim(); const name = nameInput.value.trim();
            const password = passwordInput.value.trim(); const company = companyInput.value.trim();
            const address = addressInput.value.trim(); const phone = phoneInput.value.trim();
            if (!matricula || !name || !password || !phone) { showModal('Matrícula, Nome, Senha e Telefone são obrigatórios.'); return; }
            const { error } = await supabaseClient.from('users').insert([{ matricula, name, password, company, address, phone }]);
            if (error) { console.error('Error adding user:', error); showModal('Erro ao adicionar usuário.'); } 
            else { idInput.value = nameInput.value = passwordInput.value = companyInput.value = addressInput.value = phoneInput.value = ''; showModal('Usuário adicionado com sucesso!'); }
        }

        function editUser(userId) {
            const user = state.users.find(u => u.id === userId);
            if (!user) return;
            const onConfirm = async () => {
                const newMatricula = document.getElementById('modal-input-matricula').value.trim();
                const newName = document.getElementById('modal-input-name').value.trim();
                const newPassword = document.getElementById('modal-input-password').value.trim();
                const newCompany = document.getElementById('modal-input-company').value.trim();
                const newAddress = document.getElementById('modal-input-address').value.trim();
                const newPhone = document.getElementById('modal-input-phone').value.trim();

                if (newName && newPhone) {
                    const updateData = { matricula: newMatricula, name: newName, company: newCompany, address: newAddress, phone: newPhone };
                    if (newPassword) updateData.password = newPassword;
                    const { error } = await supabaseClient.from('users').update(updateData).eq('id', userId);
                    if (error) { console.error('Error updating user:', error); showModal('Erro ao atualizar usuário.'); } 
                    else { closeModal(); }
                } else { showModal('Nome completo e telefone são obrigatórios.'); }
            };
            showModal('Editar dados do usuário:', onConfirm, true, { type: 'edit-user', matricula: user.matricula, name: user.name, company: user.company, address: user.address, phone: user.phone });
        }

        async function deleteUser(userId) {
            const onConfirm = async () => {
                const { error } = await supabaseClient.from('users').delete().eq('id', userId);
                if (error) { console.error('Error deleting user:', error); showModal('Erro ao excluir usuário.'); } 
                else { closeModal(); }
            };
            showModal('Tem certeza que deseja excluir este usuário?', onConfirm, true);
        }

        function exportUsersToExcel() {
            if (state.users.length === 0) {
                showModal("Nenhum usuário cadastrado para exportar.");
                return;
            }

            const dataToExport = state.users.map(user => ({
                'Matrícula': user.matricula,
                'Nome Completo': user.name,
                'Empresa': user.company || 'N/A',
                'Endereço': user.address || 'N/A',
                'Telefone': user.phone
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Lista de Usuários");

            worksheet['!cols'] = [
                { wch: 15 }, // Matrícula
                { wch: 35 }, // Nome Completo
                { wch: 20 }, // Empresa
                { wch: 40 }, // Endereço
                { wch: 20 }  // Telefone
            ];

            XLSX.writeFile(workbook, "relatorio_usuarios.xlsx");
        }


        // --- LÓGICA DO MOTORISTA ---
        function populateDriverSelection() {
            const list = document.getElementById('driver-list-selection');
            const timestampEl = document.getElementById('driver-selection-timestamp');
            list.innerHTML = '';
            const timestamp = new Date().toLocaleString('pt-BR');
            timestampEl.textContent = `Status atualizado em ${timestamp}`;

            state.drivers.forEach(driver => {
                const isDriverBusy = state.rides.some(ride => 
                    ride.driverId === driver.id && 
                    ride.status !== 'completed' && 
                    ride.status !== 'canceled'
                );
                const button = document.createElement('button');
                 // Usa card-gradient para o fundo dos botões de motorista
                button.className = 'w-full py-3 px-6 text-lg font-semibold rounded-lg card-gradient shadow-lg transform hover:scale-105 transition-transform flex justify-between items-center';
                button.onclick = () => selectDriver(driver.id);
                button.innerHTML = `
                    <span class="text-white">${driver.name}</span>
                    <span class="text-sm font-bold py-1 px-3 rounded-full ${driver.status === 'active' && !isDriverBusy ? 'bg-green-500 text-white' : 'bg-red-600 text-white'}">
                        ${driver.status === 'active' && !isDriverBusy ? 'Livre' : 'Ocupado'}
                    </span>
                `;
                list.appendChild(button);
            });
        }

        function selectDriver(driverId) {
            tempDriverId = driverId;
            const driver = state.drivers.find(d => d.id === driverId);
            if (!driver) return;
            const onConfirm = () => {
                const passwordInput = document.getElementById('modal-input-driver-password');
                if (passwordInput.value === driver.password) { 
                    state.currentDriverId = driverId;
                    localStorage.setItem('sessionType', 'driver');
                    localStorage.setItem('loggedInDriverId', driverId);
                    document.getElementById('driver-name-display').textContent = `Bem-vindo, ${driver.name}`;
                    updateDriverStatusButton();
                    showScreen('driver-screen');
                    closeModal();
                } else {
                    document.getElementById('modal-message').textContent = "Senha Incorreta!";
                }
            };
            showModal(`Login para ${driver.name}`, onConfirm, true, { type: 'driver-password' });
        }

        function loadDriverJobs() {
            if (!state.currentDriverId) return;
            const list = document.getElementById('driver-jobs-list');
            list.innerHTML = '';
            const myJobs = state.rides.filter(r => r.driverId === state.currentDriverId && r.status !== 'completed' && r.status !== 'canceled');
            const statsDisplay = document.getElementById('driver-stats-display');
            const jobCount = myJobs.length;
            const timestamp = new Date().toLocaleString('pt-BR');
            statsDisplay.textContent = `${jobCount} solicitações carregadas em ${timestamp}`;

            if (myJobs.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400">Nenhuma corrida para você no momento.</p>';
                stopRingingAdmin(); // Usa a função de parar do admin
                if (driverWatchId) {
                    navigator.geolocation.clearWatch(driverWatchId);
                    driverWatchId = null;
                }
                return;
            }

            let hasAssignedJob = false;
            myJobs.forEach(ride => {
                const card = document.createElement('div');
                card.className = 'card-gradient p-4 rounded-lg shadow-md';
                const requestDateTime = new Date(ride.requestTime).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                let content = `
                    <div class="flex justify-between items-start mb-1">
                        <p class="font-semibold pr-2">Destino Final: <span class="font-normal">${formatDestination(ride.destination)}</span></p> {/* Usa destino formatado */}
                        <p class="text-sm text-gray-300">Solicitado por: ${ride.userName} ${ride.userCompany ? `(${ride.userCompany})` : ''}</p>
                        <p class="text-xs text-gray-400 whitespace-nowrap">${requestDateTime}</p>
                    </div>
                    <p class="text-sm text-gray-300 mb-4">Status: <span class="font-semibold text-yellow-300">${translateStatus(ride.status).text}</span></p>
                `;
                if (ride.status === 'assigned') {
                    hasAssignedJob = true;
                    content += `<button onclick="acceptRide(${ride.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">ACEITAR CORRIDA</button>`;
                } else if (ride.status === 'accepted') {
                    content += `<button onclick="arriveAtPickup(${ride.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">CHEGUEI NO LOCAL DE EMBARQUE</button>`;
                } else if (ride.status === 'arrived_pickup') {
                    content += `<button onclick="startTrip(${ride.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg button-gradient text-white">INICIAR VIAGEM PARA O DESTINO</button>`;
                } else if (ride.status === 'in_progress') {
                    content += `<button onclick="completeRide(${ride.id})" class="mt-4 w-full py-2 px-4 font-semibold rounded-lg bg-green-600 hover:bg-green-700 text-white">FINALIZAR CORRIDA</button>`;
                }
                card.innerHTML = content;
                list.appendChild(card);
            });
            if (hasAssignedJob) startRingingAdmin(); else stopRingingAdmin();
        }

        async function acceptRide(rideId) {
            stopRingingAdmin();
            startDriverTracking(rideId); 

            const { error } = await supabaseClient.from('rides').update({ status: 'accepted', acceptTime: new Date().toISOString() }).eq('id', rideId);
            if (error) { 
                console.error("Erro ao aceitar corrida:", error);
                showModal("Não foi possível aceitar a corrida.");
            } else { 
                const ride = state.rides.find(r => r.id === rideId);
                
                // Tenta navegar para as coordenadas de origem primeiro
                if (ride && ride.userLocation && ride.userLocation.lat && ride.userLocation.lon) {
                    const { lat, lon } = ride.userLocation;
                    // Link do Waze para coordenadas
                    window.open(`waze://?ll=${lat},${lon}&navigate=yes`, '_blank');
                } else if (ride && ride.origin_address) {
                    // Fallback para endereço de origem se as coordenadas não estiverem salvas
                    window.open(`waze://?q=${encodeURIComponent(ride.origin_address)}&navigate=yes`, '_blank');
                } else {
                     showModal("Não foi possível obter a localização do usuário ou endereço de origem para navegação.");
                }
            }
        }


        async function arriveAtPickup(rideId) {
            const { error } = await supabaseClient.from('rides').update({ status: 'arrived_pickup' }).eq('id', rideId);
            if (error) {
                console.error("Erro ao atualizar status para 'chegou no local':", error);
                showModal("Não foi possível marcar como 'chegou no local'.");
            }
        }

        async function startTrip(rideId) {
            const ride = state.rides.find(r => r.id === rideId);
            if (ride) {
                const { error } = await supabaseClient.from('rides').update({ status: 'in_progress' }).eq('id', rideId);
                if (error) { 
                    console.error("Erro ao iniciar viagem:", error);
                    showModal("Não foi possível iniciar a viagem.");
                } else { 
                    // Navega para o destino final (usa o valor bruto, não formatado)
                    // Usa a função de formatação para extrair o endereço de destino principal
                    const destinationAddress = formatDestination(ride.destination);
                    window.open(`waze://?q=${encodeURIComponent(destinationAddress)}&navigate=yes`, '_blank'); 
                }
            }
        }

        async function completeRide(rideId) {
            const { error } = await supabaseClient.from('rides').update({ status: 'completed' }).eq('id', rideId);
            if (error) { 
                console.error("Erro ao completar corrida:", error); 
                showModal("Não foi possível finalizar a corrida.");
            } else {
                if (driverWatchId) {
                    navigator.geolocation.clearWatch(driverWatchId);
                    driverWatchId = null;
                }
            }
        }

        // --- RASTREAMENTO E CÁLCULO DE DISTÂNCIA ---
        function startDriverTracking(rideId) {
            if (driverWatchId) {
                navigator.geolocation.clearWatch(driverWatchId);
            }

            driverWatchId = navigator.geolocation.watchPosition(async (position) => {
                const driverLocation = { lat: position.coords.latitude, lon: position.coords.longitude };
                const currentRide = state.rides.find(r => r.id === rideId && r.status !== 'completed' && r.status !== 'canceled');
                if (currentRide) {
                    await supabaseClient.from('rides').update({ driverCurrentLocation: driverLocation }).eq('id', rideId);
                } else { // Se a corrida não for encontrada (finalizada/cancelada), para o watch
                    navigator.geolocation.clearWatch(driverWatchId);
                    driverWatchId = null;
                }
            }, (error) => { 
                console.error("Erro ao rastrear localização do motorista:", error); 
                 // Não mostra modal para não interromper o motorista constantemente
                 // Apenas loga o erro
            }, { 
                enableHighAccuracy: true, 
                timeout: 5000, 
                maximumAge: 0 
            });
        }

        // --- INICIALIZAÇÃO DO APP E SUPABASE ---
        async function fetchAllData() {
            const { data: drivers, error: driversError } = await supabaseClient.from('drivers').select('*');
            if (driversError) console.error('Error fetching drivers:', driversError); else state.drivers = drivers;
            const { data: users, error: usersError } = await supabaseClient.from('users').select('*');
            if (usersError) console.error('Error fetching users:', usersError); else state.users = users;
            const { data: rides, error: ridesError } = await supabaseClient.from('rides').select('*');
            if (ridesError) console.error('Error fetching rides:', ridesError); else state.rides = rides;
        }

        // 2. FUNÇÃO DE E-MAIL ATUALIZADA
        async function sendNewRideEmailNotification(ride) {
            console.log('Tentando enviar e-mail para a nova corrida:', ride);
            // Instancia o Resend com a chave de API
            const resend = new Resend('re_Qp3oqRvJ_5QKw8pW1zv9VF8kd7pTt6m8V'); // ATENÇÃO: Chave exposta no frontend!

            try {
                // Monta o conteúdo do e-mail
                const subject = `Nova Solicitação de Corrida: ${ride.userName}`;
                const htmlBody = `
                  <h1>Nova Solicitação de Corrida Recebida</h1>
                  <p>Uma nova solicitação de corrida foi registrada no sistema.</p>
                  <h2>Detalhes:</h2>
                  <ul>
                    <li><strong>Usuário:</strong> ${ride.userName || 'Não informado'}</li>
                    <li><strong>Empresa:</strong> ${ride.userCompany || 'N/A'}</li>
                    <li><strong>Origem:</strong> ${ride.origin_address || 'Não informada'}</li>
                    <li><strong>Destino:</strong> ${formatDestination(ride.destination)}</li> {/* Usa destino formatado */}
                    <li><strong>Observação:</strong> ${ride.observation || 'Nenhuma'}</li>
                    <li><strong>Tipo:</strong> ${ride.request_type === 'scheduled' ? `Agendada para ${new Date(ride.scheduled_datetime).toLocaleString('pt-BR')}` : 'Imediata'}</li>
                    <li><strong>Horário da Solicitação:</strong> ${new Date(ride.requestTime).toLocaleString('pt-BR')}</li>
                  </ul>
                  <p>Por favor, acesse o painel de administrador para designar um motorista.</p>
                `;

                // Envia o e-mail
                const { data, error } = await resend.emails.send({
                  from: 'GARCIA TRANSPORTES <onboarding@resend.dev>', // Remetente precisa ser um domínio verificado
                  to: ['engelmobile2020@gmail.com'], // Destinatário(s)
                  subject: subject,
                  html: htmlBody,
                });

                if (error) {
                    console.error('Erro ao enviar e-mail pela Resend:', error);
                    alert('A notificação da corrida foi recebida, mas houve uma falha ao enviar o e-mail de alerta.');
                } else {
                    console.log('E-mail de notificação enviado com sucesso:', data);
                }

            } catch (error) {
                console.error('Erro crítico ao tentar enviar e-mail:', error);
                alert('Ocorreu um erro inesperado ao processar o envio do e-mail.');
            }
        }


        function setupRealtimeSubscriptions() {
            supabaseClient.channel('public:drivers').on('postgres_changes', { event: '*', schema: 'public', table: 'drivers' }, payload => {
                fetchAllData().then(() => { 
                    const activeScreen = document.querySelector('.screen.active')?.id;
                    if (activeScreen === 'admin-driver-crud-screen') renderDriverCrudList();
                    else if (activeScreen === 'driver-selection-screen') populateDriverSelection();
                    if (activeScreen === 'user-screen') updateAvailableDriversCount();
                });
            }).subscribe();

            supabaseClient.channel('public:users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, payload => {
                 fetchAllData().then(() => {
                    if (document.querySelector('.screen.active')?.id === 'admin-user-crud-screen') renderUserCrudList();
                 });
            }).subscribe();

            supabaseClient.channel('public:rides').on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, payload => {

                if (localStorage.getItem('sessionType') === 'admin') {
                    // Toca o alarme e envia e-mail quando uma nova corrida é INSERIDA
                    if (payload.eventType === 'INSERT' && (payload.new.status === 'requested' || payload.new.status === 'scheduled')) {
                        startRingingAdmin();
                        sendNewRideEmailNotification(payload.new);
                    }
                    // Toca o alarme quando uma corrida existente é ATUALIZADA para o status 'approved'
                    else if (payload.eventType === 'UPDATE' && payload.new.status === 'approved' && payload.old.status !== 'approved') {
                        startRingingAdmin();
                    }
                }

                fetchAllData().then(() => {
                    const activeScreenId = document.querySelector('.screen.active')?.id;
                    if (activeScreenId === 'admin-requests-screen') {
                        loadAdminRequests();
                        renderOngoingRidesTable();
                    }
                    else if (activeScreenId === 'driver-screen') loadDriverJobs();
                    else if (activeScreenId === 'user-screen') {
                        checkUserRideStatus(); 
                        updateAvailableDriversCount(); 
                        renderUserRideHistory(); 
                    }
                    else if (activeScreenId === 'driver-selection-screen') {
                        populateDriverSelection(); 
                    }
                     // ATUALIZA REGISTROS SE A TELA ESTIVER ATIVA
                     else if (activeScreenId === 'admin-records-screen') {
                        loadAllRecords();
                    }
                });
            }).subscribe();
        }

        // --- FUNÇÕES DE STATUS ---
        function updateDriverStatusButton() {
            const driver = state.drivers.find(d => d.id === state.currentDriverId);
            if (!driver) return;
            const toggle = document.getElementById('driver-status-toggle');
            const label = document.getElementById('driver-status-label');
            if (driver.status === 'active') {
                toggle.checked = true; 
                label.textContent = 'ATIVO'; 
                label.className = 'font-bold text-green-400';
            } else {
                toggle.checked = false; 
                label.textContent = 'INATIVO'; 
                label.className = 'font-bold text-red-400';
            }
        }

        async function toggleDriverStatus() {
            const driver = state.drivers.find(d => d.id === state.currentDriverId);
            if (driver) {
                const newStatus = driver.status === 'active' ? 'inactive' : 'active';
                const { error } = await supabaseClient.from('drivers').update({ status: newStatus }).eq('id', driver.id);
                if (error) console.error("Error updating driver status:", error);
            }
        }

        async function toggleDriverStatusAdmin(driverId) {
            const driver = state.drivers.find(d => d.id === driverId);
            if (driver) {
                const newStatus = driver.status === 'active' ? 'inactive' : 'active';
                const { error } = await supabaseClient.from('drivers').update({ status: newStatus }).eq('id', driver.id);
                if (error) console.error("Error updating driver status:", error);
            }
        }

        function updateAvailableDriversCount() {
            const availableDrivers = state.drivers.filter(driver => {
                const hasActiveRide = state.rides.some(ride => 
                    ride.driverId === driver.id && 
                    ride.status !== 'completed' && 
                    ride.status !== 'canceled'
                );
                return driver.status === 'active' && !hasActiveRide;
            });
            const countEl = document.getElementById('available-drivers-count');
            if (countEl) { 
                // Altera a cor do texto para escuro para melhor contraste
                countEl.className = 'text-center mb-4 text-lg text-green-800 font-semibold';
                countEl.textContent = `Motoristas disponíveis agora: ${availableDrivers.length}`;
            }
        }

        const customDataLabels = {
            id: 'customDataLabels',
            afterDraw(chart, args, options) {
                const { ctx, data } = chart;
                const total = data.datasets[0].data.reduce((acc, current) => acc + current, 0);

                if (total === 0) return;

                const centerX = chart.getDatasetMeta(0).data[0].x;
                const centerY = chart.getDatasetMeta(0).data[0].y;

                ctx.save();
                ctx.font = 'bold 40px Poppins';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(total, centerX, centerY);
                ctx.restore();
            }
        };

        function renderDriverStatusChart(active, inactive) {
            const ctx = document.getElementById('driver-status-chart').getContext('2d');
            if (driverChart) driverChart.destroy();
            driverChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ativos', 'Inativos'],
                    datasets: [{
                        data: [active, inactive],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderColor: '#374151',
                        borderWidth: 5,
                        hoverBorderWidth: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                },
                plugins: [customDataLabels]
            });
        }

        function translateStatus(status) {
            if (!status) {
                return { text: 'INDEFINIDO', colorClass: 'status-canceled' };
            }
            switch (status) {
                case 'pending_approval': return { text: 'PEND. APROVAÇÃO', colorClass: 'status-pending_approval' };
                case 'approved': return { text: 'APROVADA', colorClass: 'status-approved' };
                case 'rejected': return { text: 'REJEITADA', colorClass: 'status-rejected' };
                case 'requested': return { text: 'SOLICITADO', colorClass: 'status-requested' };
                case 'assigned': return { text: 'DESIGNADO', colorClass: 'status-assigned' };
                case 'accepted': return { text: 'ACEITO', colorClass: 'status-accepted' };
                case 'arrived_pickup': return { text: 'NO EMBARQUE', colorClass: 'status-arrived_pickup' };
                case 'in_progress': return { text: 'EM ANDAMENTO', colorClass: 'status-in_progress' };
                case 'completed': return { text: 'FINALIZADA', colorClass: 'status-completed' };
                case 'canceled': return { text: 'CANCELADA', colorClass: 'status-canceled' };
                default: return { text: status.toUpperCase(), colorClass: '' }; 
            }
        }

        function exportDailyReportNow() {
            if (state.rides.length === 0) {
                 showModal("Nenhuma corrida encontrada para exportar.");
                return;
            }

            const dataToExport = state.rides.map(ride => ({
                'ID da Corrida': ride.id,
                'Usuário': ride.userName,
                'Empresa': ride.userCompany,
                'Destino': formatDestination(ride.destination), // Usa destino formatado
                'Motorista': ride.driverName || 'N/A',
                'Data da Solicitação': new Date(ride.requestTime).toLocaleString('pt-BR'),
                'Data do Aceite': ride.acceptTime ? new Date(ride.acceptTime).toLocaleString('pt-BR') : 'N/A',
                'Status': translateStatus(ride.status).text
            }));

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Relatorio de Corridas");
            XLSX.writeFile(workbook, `Relatorio_Diario_${dateStr}.xlsx`);
        }


        function exportRidesToExcel() { // Esta função parece não ser mais usada diretamente, mas a deixo caso precise
            const startDate = document.getElementById('start-date').value; // Presume que existem inputs com 'start-date' e 'end-date' em algum lugar
            const endDate = document.getElementById('end-date').value;
            if (!startDate || !endDate) { showModal("Por favor, selecione a data inicial e final."); return; }
            const start = new Date(startDate).getTime();
            const end = new Date(endDate); 
            end.setHours(23, 59, 59, 999); 

            const filteredRides = state.rides.filter(ride => {
                const rideTime = new Date(ride.requestTime).getTime();
                return rideTime >= start && rideTime <= end.getTime();
            });
            if (filteredRides.length === 0) { showModal("Nenhuma corrida encontrada no período selecionado."); return; }

            const dataToExport = filteredRides.map(ride => ({
                'ID da Corrida': ride.id, 'Usuário': ride.userName, 'Empresa': ride.userCompany,
                'Destino': formatDestination(ride.destination), // Usa destino formatado
                 'Motorista': ride.driverName || 'N/A',
                'Data da Solicitação': new Date(ride.requestTime).toLocaleString('pt-BR'),
                'Data do Aceite': ride.acceptTime ? new Date(ride.acceptTime).toLocaleString('pt-BR') : 'N/A',
                'Status': translateStatus(ride.status).text
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Relatorio de Corridas");
            XLSX.writeFile(workbook, `Relatorio_Corridas_${startDate}_a_${end.toISOString().split('T')[0]}.xlsx`);
        }

        function uploadAppIcon() {
            const fileInput = document.getElementById('icon-file-input');
            const file = fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                state.appIcon = event.target.result;
                localStorage.setItem('appIcon', state.appIcon);
                loadAppIcon(); 
                showModal('Ícone atualizado com sucesso!');
            };
            reader.readAsDataURL(file);
        }

        function loadAppIcon() {
            const iconContainer = document.getElementById('app-icon-container');
            iconContainer.innerHTML = ''; 
            if (state.appIcon) {
                const img = document.createElement('img');
                img.src = state.appIcon; img.className = 'h-12 w-12 object-contain';
                iconContainer.appendChild(img);
            } else {
                 // Ícone padrão SVG caso nenhum seja carregado
                 const defaultIconContainer = document.getElementById('app-icon-container');
                 if (defaultIconContainer.innerHTML === '') { // Adiciona apenas se estiver vazio
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('class', 'h-12 w-12 text-black'); // Ícone preto
                    svg.setAttribute('fill', 'currentColor');
                    svg.setAttribute('viewBox', '0 0 20 20');
                    svg.innerHTML = `<path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />`; // Ícone de usuário simples
                    defaultIconContainer.appendChild(svg);
                 }
            }
        }

        function renderUserRideHistory() {
            const historyContainer = document.getElementById('user-ride-history');
            historyContainer.innerHTML = '';
            const userRides = state.rides.filter(r => r.userId === state.currentUserId);
            if (userRides.length === 0) {
                historyContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum histórico de corrida.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            table.innerHTML = `
                <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
                    <tr>
                        <th scope="col" class="px-4 py-3">Data</th>
                        <th scope="col" class="px-4 py-3">Destino</th>
                        <th scope="col" class="px-4 py-3">Status</th>
                    </tr>
                </thead>`;
            const tbody = document.createElement('tbody');
            userRides.sort((a, b) => new Date(b.requestTime) - new Date(a.requestTime));
            userRides.forEach(ride => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `
                    <td class="px-4 py-3">${new Date(ride.requestTime).toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3">${formatDestination(ride.destination)}</td> {/* Usa destino formatado */}
                    <td class="px-4 py-3">${translateStatus(ride.status).text}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            historyContainer.appendChild(table);
        }

        function renderDriverRideHistory() {
            const historyContainer = document.getElementById('driver-ride-history');
            historyContainer.innerHTML = '';
            const driverRides = state.rides.filter(r => r.driverId === state.currentDriverId && r.status === 'completed');
            if (driverRides.length === 0) {
                historyContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum histórico de corrida.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            table.innerHTML = `
                <thead class="text-xs text-gray-300 uppercase bg-gray-900/30">
                    <tr>
                        <th scope="col" class="px-4 py-3">Data</th>
                        <th scope="col" class="px-4 py-3">Usuário</th>
                        <th scope="col" class="px-4 py-3">Destino</th>
                    </tr>
                </thead>`;
            const tbody = document.createElement('tbody');
            driverRides.sort((a, b) => new Date(b.requestTime) - new Date(a.requestTime));
            driverRides.forEach(ride => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `
                    <td class="px-4 py-3">${new Date(ride.requestTime).toLocaleDateString('pt-BR')}</td>
                    <td class="px-4 py-3">${ride.userName}</td>
                    <td class="px-4 py-3">${formatDestination(ride.destination)}</td> {/* Usa destino formatado */}
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            historyContainer.appendChild(table);
        }

        function exportUserRidesToExcel() {
            const userRides = state.rides.filter(r => r.userId === state.currentUserId);
            if (userRides.length === 0) { showModal("Nenhum histórico de corrida para exportar."); return; }

            const dataToExport = userRides.map(ride => ({
                'Data da Solicitação': new Date(ride.requestTime).toLocaleString('pt-BR'),
                'Destino': formatDestination(ride.destination), // Usa destino formatado
                'Motorista': ride.driverName || 'N/A',
                'Status': translateStatus(ride.status).text
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Minhas Corridas");
            XLSX.writeFile(workbook, "meu_historico_corridas.xlsx");
        }

        function exportDriverRidesToExcel() {
            const driverRides = state.rides.filter(r => r.driverId === state.currentDriverId && r.status === 'completed');
            if (driverRides.length === 0) { showModal("Nenhum histórico de corrida para exportar."); return; }

            const dataToExport = driverRides.map(ride => ({
                'Data da Solicitação': new Date(ride.requestTime).toLocaleString('pt-BR'),
                'Usuário': ride.userName,
                'Empresa': ride.userCompany,
                'Destino': formatDestination(ride.destination), // Usa destino formatado
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Minhas Corridas Concluídas");
            XLSX.writeFile(workbook, "meu_historico_corridas_concluidas.xlsx");
        }

        // --- FUNÇÕES PARA REGISTROS ---
        function openRecordsTab() {
            showScreen('admin-records-screen');
        }

        // ========================================================================
        // FUNÇÃO CORRIGIDA (loadAllRecords)
        // ========================================================================
        async function loadAllRecords() {
            const tableBody = document.getElementById('all-records-body');
            // Colspan atualizado para 9 colunas
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4"><div class="loader mx-auto"></div></td></tr>';

            const { data, error } = await supabaseClient.from('rides').select('*').order('requestTime', { ascending: false });
            if (error) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-500">Erro ao carregar registros.</td></tr>';
                return;
            }
            state.rides = data;

            // --- Preencher filtro de empresas ---
            const companySelect = document.getElementById('records-company-filter');
            if (companySelect) {
                companySelect.innerHTML = '<option value="" class="text-gray-400">Todas as Empresas</option>'; 
                const companies = [...new Set(data.map(ride => ride.userCompany || '-').filter(Boolean))];
                companies.sort().forEach(company => {
                    if (company) { 
                        companySelect.innerHTML += `<option value="${company}" class="text-white">${company}</option>`; // Adiciona classe text-white
                    }
                });
            }
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-400">Nenhum registro encontrado.</td></tr>';
                return;
            }

            // Geração das linhas da tabela modificada
            const rowPromises = data.map(async (ride) => {
                let distanceKm = 'N/D';
                const originAddress = cleanAddressString(ride.origin_address) || '-'; 
                 // Usa a função formatDestination
                const destinationAddress = formatDestination(ride.destination);

                // Usa os endereços brutos para calcular a distância
                if (ride.origin_address && ride.destination) {
                    // Evita chamar a API se a origem ou destino formatado ainda for o JSON bruto (indicando falha na formatação inicial)
                    const rawOrigin = ride.origin_address;
                    const rawDestination = ride.destination;
                    if(rawOrigin && rawDestination && !rawOrigin.startsWith('[{') && !rawDestination.startsWith('[{')) {
                        const distance = await getDrivingDistance(rawOrigin, rawDestination); 
                        if (distance !== null) {
                            distanceKm = distance.toFixed(2);
                        } else {
                            distanceKm = 'Erro';
                        }
                    } else {
                        distanceKm = 'N/A'; // Não calcula se os dados estiverem mal formatados
                    }
                }

                const statusInfo = translateStatus(ride.status);
                // Usar requestTime para a data exibida na primeira coluna
                const requestDateTime = ride.requestTime ? new Date(ride.requestTime).toLocaleString('pt-BR') : 'N/A'; 
                const observation = ride.observation || '-';
                const requestTimestamp = new Date(ride.requestTime).getTime(); // Mantém para filtro

                // CORREÇÃO: Comentário removido da linha abaixo
                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-800/20" data-request-time="${requestTimestamp}">
                        <td class="px-4 py-3">${requestDateTime}</td> 
                        <td class="px-4 py-3">${ride.userName}</td>
                        <td class="px-4 py-3">${ride.userCompany || '-'}</td>
                        <td class="px-4 py-3">${originAddress}</td>
                        <td class="px-4 py-3">${destinationAddress}</td> 
                        <td class="px-4 py-3">${observation}</td>
                        <td class="px-4 py-3">${ride.driverName || '-'}</td>
                        <td class="px-4 py-3"><span class="status-badge ${statusInfo.colorClass}">${statusInfo.text}</span></td>
                        <td class="px-4 py-3">${distanceKm}</td> 
                    </tr>
                `;
            });

            tableBody.innerHTML = (await Promise.all(rowPromises)).join('');
        }

        // ========================================================================
        // FUNÇÃO filterRecords (sem alteração lógica)
        // ========================================================================
        function filterRecords() {
            const startDate = document.getElementById('records-start-date').value;
            const endDate = document.getElementById('records-end-date').value;
            const selectedCompany = document.getElementById('records-company-filter').value;
            const tableBody = document.getElementById('all-records-body');
            const rows = Array.from(tableBody.querySelectorAll('tr'));

            const start = startDate ? new Date(startDate).getTime() : null;
            const end = endDate ? new Date(endDate).setHours(23, 59, 59, 999) : null;

            rows.forEach(row => {
                const requestTimestamp = row.dataset.requestTime;
                const companyCell = row.cells[2]; 
                
                if (requestTimestamp && companyCell) {
                    const recordDate = parseInt(requestTimestamp);
                    let dateMatch = true;
                    if (start && recordDate < start) dateMatch = false;
                    if (end && recordDate > end) dateMatch = false;

                    const rowCompany = companyCell.textContent.trim();
                    let companyMatch = (selectedCompany === "" || rowCompany === selectedCompany);

                    row.style.display = (dateMatch && companyMatch) ? '' : 'none';
                }
            });
        }

        // ========================================================================
        // FUNÇÃO CORRIGIDA (exportRecordsToExcel)
        // ========================================================================
        function exportRecordsToExcel() {
            const table = document.getElementById('all-records-table');
            const rows = table.querySelectorAll('tbody tr');
            const dataToExport = [];

            // 1. Adiciona os cabeçalhos da tabela
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            dataToExport.push(headers); 

            // 2. Adiciona apenas as linhas visíveis (filtradas)
            let visibleRows = 0;
            rows.forEach(row => {
                if (row.style.display !== 'none') { 
                    const cells = Array.from(row.querySelectorAll('td')).map(td => {
                        if (td.querySelector('.status-badge')) {
                            return td.querySelector('.status-badge').textContent.trim();
                        }
                        return td.textContent.trim();
                    });
                    dataToExport.push(cells);
                    visibleRows++;
                }
            });

            // 3. Verifica se há dados para exportar
            if (visibleRows === 0) {
                showModal("Nenhum registro (visível) encontrado para exportar. Verifique seus filtros.");
                return;
            }

            // 4. Cria e baixa o arquivo Excel
            const worksheet = XLSX.utils.aoa_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Registros");

            // Define larguras de coluna
            worksheet['!cols'] = [
                { wch: 20 }, // Data Solicitação
                { wch: 25 }, // Usuário
                { wch: 20 }, // Empresa
                { wch: 40 }, // Origem
                { wch: 40 }, // Destino
                { wch: 30 }, // Observação
                { wch: 25 }, // Motorista
                { wch: 15 }, // Status
                { wch: 15 }  // Distância (km)
            ];

            XLSX.writeFile(workbook, "relatorio_de_registros.xlsx");
        }

        // ========================================================================
        // NOVA FUNÇÃO - LIMPAR FILTRO
        // ========================================================================
        function clearRecordsFilter() {
            // 1. Limpa os campos de input
            document.getElementById('records-start-date').value = '';
            document.getElementById('records-end-date').value = '';
            document.getElementById('records-company-filter').value = ''; // Reseta o select

            // 2. Mostra todas as linhas da tabela novamente
            const tableBody = document.getElementById('all-records-body');
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            
            rows.forEach(row => {
                row.style.display = ''; // Remove o 'display: none'
            });
        }


        async function adminCompleteRide(rideId) {
            if (!confirm('Tem certeza que deseja finalizar esta corrida?')) return;
            const { error } = await supabaseClient.from('rides').update({ status: 'completed' }).eq('id', rideId);
            if (error) alert('Não foi possível finalizar a corrida.');
            else alert('Corrida finalizada com sucesso!');
        }

        async function adminDeleteRide(rideId) {
            if (!confirm('ATENÇÃO: Ação irreversível. Deseja realmente excluir esta corrida?')) return;
            const { error } = await supabaseClient.from('rides').delete().eq('id', rideId);
            if (error) alert('Não foi possível excluir a corrida.');
            else alert('Corrida excluída com sucesso!');
        }

        // --- FUNÇÃO DE INICIALIZAÇÃO PRINCIPAL ---
        async function initApp() {
            // Esta função não precisa mais verificar o 'google', 
            // ela será chamada pelo DOMContentLoaded
            
            initAutocomplete(); // Esta função agora está vazia, mas é chamada
            await fetchAllData(); 
            setupRealtimeSubscriptions(); 
            loadAppIcon();

            const sessionType = localStorage.getItem('sessionType');
            if (sessionType === 'admin') {
                showScreen('admin-screen');
            } else if (sessionType === 'user') {
                const userId = localStorage.getItem('loggedInUserId');
                if (userId && state.users.some(u => u.id == userId)) {
                    state.currentUserId = parseInt(userId);
                    showScreen('user-screen');
                } else {
                    logout();
                }
            } else if (sessionType === 'driver') {
                const driverId = localStorage.getItem('loggedInDriverId');
                if (driverId && state.drivers.some(d => d.id == driverId)) {
                    state.currentDriverId = parseInt(driverId);
                    const driver = state.drivers.find(d => d.id === state.currentDriverId);
                    document.getElementById('driver-name-display').textContent = `Bem-vindo, ${driver.name}`;
                    updateDriverStatusButton();
                    showScreen('driver-screen');
                } else {
                    logout();
                }
            } else {
                showScreen('initial-screen');
            }
        }

        // ========================================================================
        // FUNÇÃO ATUALIZADA - initAutocomplete
        // ========================================================================
        // Esta função agora inicializa o Geoapify Autocomplete
        function initAutocomplete(inputElement, onPlaceSelectCallback) {
            // Se nenhum elemento for passado, a função é encerrada
            // Isso acontece na chamada antiga de initApp()
            if (!inputElement) return;

            // Evita reinicializar em um input que já tem
            if (inputElement.geoapify_autocomplete_instance) {
                inputElement.geoapify_autocomplete_instance.destroy();
                inputElement.geoapify_autocomplete_instance = null;
            }

            const autocomplete = new Autocomplete(inputElement, {
                apiKey: GEOAPIFY_API_KEY,
                filter: {
                    countrycode: ['br'] // Filtra para o Brasil
                },
                lang: 'pt', // Define o idioma para Português
                placeholder: inputElement.placeholder,
                allowNonVerifiedHouseNumber: true,
                allowNonVerifiedStreet: true
            });

            autocomplete.on('select', (feature) => {
                if (feature) {
                    // Se um callback foi fornecido (como na tela do usuário),
                    // chama ele com os dados do local selecionado
                    if (onPlaceSelectCallback) {
                        onPlaceSelectCallback(feature);
                    }
                }
            });
            
            // Armazena a instância no elemento para referência futura (ex: no modal)
            inputElement.geoapify_autocomplete_instance = autocomplete;
        }

        // ========================================================================
        // FUNÇÃO ATUALIZADA - initHeatmap (agora usa Leaflet)
        // ========================================================================
        async function initHeatmap() {
            const mapDiv = document.getElementById('heatmap-canvas');
            if (!mapDiv) {
                console.error('Elemento do mapa não encontrado');
                return;
            }

            // Remove o mapa Leaflet anterior, se existir, para evitar duplicação
            if (map) {
                map.remove();
                map = null;
            }
            
            // Centro aproximado de Guaíba/Porto Alegre
            const center = [-30.0346, -51.2177]; // [lat, lng] para Leaflet
            
            try {
                // 1. Inicializa o mapa Leaflet
                map = L.map(mapDiv).setView(center, 12);

                // 2. Adiciona o mapa-base (tile layer) do Geoapify
                // Usando o estilo "dark-matter" que combina com seu app
                L.tileLayer(`https://maps.geoapify.com/v1/tile/dark-matter/{z}/{x}/{y}.png?apiKey=${GEOAPIFY_API_KEY}`, {
                    attribution: 'Powered by <a href="https://www.geoapify.com/" target="_blank">Geoapify</a>'
                }).addTo(map);

                console.log('Mapa Leaflet inicializado, buscando endereços dos usuários...');

                // 3. Busca e geocodifica os endereços (usando a *nova* função geocodeAddress)
                const geocodePromises = state.users
                    .filter(user => user.address && user.address.trim() !== '')
                    .map(user => {
                        return geocodeAddress(user.address)
                            .then(coords => {
                                // geocodeAddress retorna {lat, lng}
                                return coords;
                            })
                            .catch(e => {
                                console.error(`Erro ao geocodificar ${user.address}:`, e);
                                return null;
                            });
                    });

                const results = await Promise.all(geocodePromises);
                
                // 4. Formata os dados para o Leaflet.heat ([lat, lng])
                const locationsData = results
                    .filter(coords => coords) // Filtra os nulos
                    .map(coords => [coords.lat, coords.lng]); // Formato [lat, lng]

                console.log(`Total de coordenadas válidas: ${locationsData.length}`);

                // 5. Adiciona a camada de heatmap
                if (locationsData.length > 0) {
                    if (heatmap) heatmap.remove(); // Remove heatmap anterior
                    
                    heatmap = L.heatLayer(locationsData, {
                        radius: 40,
                        blur: 20,
                        maxZoom: 18,
                        gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'} // Gradiente padrão
                    }).addTo(map);
                    
                    // Ajusta o zoom para incluir todos os pontos
                    const bounds = L.latLngBounds(locationsData);
                    map.fitBounds(bounds);
                } else {
                    console.warn('Nenhuma coordenada válida encontrada para gerar o mapa de calor');
                    showModal('Não foi possível geocodificar os endereços dos usuários para gerar o mapa de calor');
                }
            } catch (error) {
                console.error('Erro ao inicializar o mapa de calor:', error);
                showModal('Erro ao carregar o mapa de calor. Verifique o console para detalhes.');
            }
        }

        // Chama loadAppIcon no final para garantir que o ícone padrão seja carregado se não houver um salvo
        document.addEventListener('DOMContentLoaded', () => {
             loadAppIcon();
             // Chama o initApp() DEPOIS que o DOM estiver carregado
             initApp();
        });

    </script>
   
   <style>
    /* Estilo do heatmap já foi movido para o <style> principal no <head> */
   </style>
</body>
</html>